<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åå¤å±‹è¦ªå­æ—…å¸³ | Nagoya Trip</title>
    
    <!-- Vue 3 (Global) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, query, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        window.firebaseModules = { 
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, 
            getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, query, setDoc, getDoc 
        };
    </script>

    <style>
        body {
            font-family: 'Noto Sans TC', 'Noto Sans JP', sans-serif;
            background-color: #FDFCF8; /* å’Œç´™ç™½ */
            color: #433D3C; /* å¢¨é»‘ */
            overflow: hidden; /* é˜²æ­¢æ•´å€‹é é¢æ²å‹•ï¼Œåªæ²å‹•å…§å®¹å€ */
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .bg-sidebar { background-color: #F4F1EA; } 
        .bg-active { background-color: #4B9CD3; color: white; } /* æ”¹ç‚ºé©åˆåå¤å±‹/æµ·é‚Šçš„è—è‰²ç³» */
        .text-accent { color: #2C5282; } 
        .bg-card { background-color: #FFFFFF; }
        .border-soft { border-color: #EDE9E0; }
        .prose-tips p { margin-bottom: 0.5em; line-height: 1.6; }
        .prose-tips ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 0.5em; }
        .prose-tips strong { color: #4B9CD3; font-weight: 700; }
        .prose-tips li { margin-bottom: 0.3em; }
        
        /* ğŸ“± æ‰‹æ©Ÿåº•éƒ¨å®‰å…¨å€åŸŸä¿®æ­£ */
        .pb-safe {
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }
    </style>
</head>
<body>

<!-- ä¿®æ­£é«˜åº¦ç‚º 100dvh ä»¥é©æ‡‰æ‰‹æ©Ÿç€è¦½å™¨ -->
<div id="app" class="flex h-[100dvh] w-full max-w-md mx-auto shadow-2xl relative overflow-hidden bg-[#FDFCF8]">

    <!-- å·¦å´å°èˆªæ¬„ -->
    <nav class="w-[80px] bg-sidebar flex flex-col items-center py-6 border-r border-soft h-full overflow-y-auto no-scrollbar z-20 flex-shrink-0">
        <!-- å€’æ•¸è¨ˆæ™‚ -->
        <div class="mb-4 flex flex-col items-center justify-center w-14 h-14 rounded-full bg-[#433D3C] text-white shadow-lg relative overflow-hidden group cursor-default">
            <div class="absolute inset-0 bg-white/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
            <span class="text-[8px] opacity-70 mb-0.5">è·é›¢å‡ºç™¼</span>
            <div class="flex items-baseline"><span class="text-sm font-bold font-mono leading-none">{{ daysRemaining }}</span><span class="text-[8px] ml-[1px]">å¤©</span></div>
        </div>

        <!-- è¨˜å¸³åŠ©æ‰‹æŒ‰éˆ• (ç½®é ‚) -->
        <div class="w-full px-2 mb-4 border-b border-gray-200 pb-4 flex flex-col items-center">
            <button @click="currentView = 'expense'" 
                class="flex flex-col items-center justify-center w-14 py-3 rounded-xl transition-all shadow-sm"
                :class="currentView === 'expense' ? 'bg-[#4B9CD3] text-white shadow-md scale-105' : 'bg-white border border-gray-100 text-gray-600 hover:bg-gray-50'">
                <i data-lucide="wallet" class="w-6 h-6 mb-1"></i>
                <span class="text-[10px] font-bold">è¨˜å¸³</span>
            </button>
        </div>

        <!-- å¤©æ•¸é¸å–® -->
        <div class="flex-1 w-full space-y-3 flex flex-col items-center overflow-y-auto no-scrollbar pb-4">
            <button v-for="(day, index) in itinerary" :key="index" @click="switchDay(index)" class="flex flex-col items-center justify-center w-12 py-2 rounded-xl transition-all duration-300" :class="currentView === 'itinerary' && activeDayIndex === index ? 'bg-active shadow-md transform scale-105' : 'text-gray-400 hover:bg-white/50'">
                <i :data-lucide="getDayIcon(index)" class="w-5 h-5 mb-1"></i><span class="text-[10px] font-bold">Day {{ index + 1 }}</span><span class="text-[8px] font-mono opacity-80">{{ day.shortDate }}</span>
            </button>
            <div class="flex flex-col gap-2 mt-2 border-t border-gray-200 pt-2 w-full items-center">
                <button @click="addNewDay" class="flex items-center justify-center w-8 h-8 rounded-full border-2 border-dashed border-gray-300 text-gray-400 hover:border-[#4B9CD3] hover:text-[#4B9CD3] hover:bg-white transition-all" title="æ–°å¢å¤©æ•¸"><i data-lucide="plus" class="w-4 h-4"></i></button>
                <button v-if="itinerary.length > 1" @click="removeLastDay" class="flex items-center justify-center w-8 h-8 rounded-full border-2 border-dashed border-gray-300 text-gray-400 hover:border-red-400 hover:text-red-400 hover:bg-white transition-all" title="åˆªé™¤æœ€å¾Œä¸€å¤©"><i data-lucide="minus" class="w-4 h-4"></i></button>
            </div>
        </div>

        <!-- åº•éƒ¨åŠŸèƒ½éµ (å¢åŠ  pb-safe å®‰å…¨è·é›¢) -->
        <div class="mt-auto w-full flex flex-col items-center space-y-3 border-t border-gray-200 pt-4 pb-safe bg-sidebar z-30">
            <button @click="currentView = 'settings'" class="flex flex-col items-center justify-center w-12 py-2 rounded-xl transition-all" :class="currentView === 'settings' ? 'bg-gray-200 text-gray-600' : 'text-gray-400'"><i data-lucide="settings" class="w-5 h-5 mb-1"></i><span class="text-[9px]">è¨­å®š</span></button>
            <button @click="currentView = 'emergency'" class="flex flex-col items-center justify-center w-12 py-2 rounded-xl transition-all" :class="currentView === 'emergency' ? 'bg-red-50 text-red-500 border border-red-100' : 'text-gray-400'"><i data-lucide="siren" class="w-5 h-5 mb-1"></i><span class="text-[9px]">æ±‚åŠ©</span></button>
        </div>
    </nav>

    <!-- å³å´ä¸»è¦å…§å®¹å€ -->
    <main class="flex-1 h-full overflow-y-auto no-scrollbar bg-[#FDFCF8] relative">
        
        <!-- VIEW: è¡Œç¨‹è¡¨ -->
        <div v-if="currentView === 'itinerary'" class="min-h-full pb-safe">
            <div class="px-6 pt-8 pb-4">
                <div class="flex justify-between items-center mb-3">
                    <div class="inline-block bg-[#4B9CD3] text-white text-[10px] font-bold px-3 py-1 rounded-full tracking-wider shadow-sm">DAY {{ activeDayIndex + 1 }} â€¢ {{ currentDayData.date }}</div>
                    <span v-if="dbConnected" class="text-[9px] text-green-600 bg-green-50 px-2 py-1 rounded-full flex items-center gap-1"><i data-lucide="cloud" class="w-3 h-3"></i> å·²åŒæ­¥</span>
                </div>
                
                <!-- å¯ç·¨è¼¯æ¨™é¡Œèˆ‡æè¿° -->
                <div v-if="!isEditingTitle">
                    <h1 class="text-2xl font-bold text-[#433D3C] leading-tight mb-2" @click="startEditTitle">{{ currentDayData.title }}</h1>
                    <p class="text-xs text-gray-500 leading-relaxed mb-4" @click="startEditTitle">{{ currentDayData.desc }}</p>
                </div>
                <div v-else class="mb-4 space-y-2 animate-in fade-in">
                    <input v-model="tempTitle.title" class="w-full text-xl font-bold bg-gray-50 border rounded px-2 py-1">
                    <textarea v-model="tempTitle.desc" class="w-full text-xs bg-gray-50 border rounded px-2 py-1" rows="2"></textarea>
                    <div class="flex gap-2"><button @click="isEditingTitle = false" class="text-xs bg-gray-100 px-3 py-1 rounded">å–æ¶ˆ</button><button @click="saveTitle" class="text-xs bg-[#4B9CD3] text-white px-3 py-1 rounded font-bold">å„²å­˜</button></div>
                </div>

                <div class="flex flex-wrap gap-2 mb-4">
                    <span v-for="tag in currentDayData.tags" :key="tag" class="flex items-center gap-1 bg-blue-50 text-[#2C5282] px-2 py-1 rounded-lg text-[10px] font-bold border border-[#4B9CD3]/30"><i data-lucide="thumbs-up" class="w-3 h-3"></i> {{ tag }}</span>
                </div>

                <!-- å°éŠå°æ’‡æ­¥ (æ‰‹å‹•ç·¨è¼¯ç‰ˆ) -->
                <div class="bg-[#433D3C] text-white p-4 rounded-2xl shadow-lg mb-6 relative overflow-hidden group min-h-[100px] transition-all duration-300">
                    <div class="absolute top-0 right-0 w-16 h-16 bg-white/10 rounded-bl-full pointer-events-none"></div>
                    <div class="flex justify-between items-start relative z-10 mb-2">
                        <div class="flex items-center gap-2"><i data-lucide="lightbulb" class="w-4 h-4 text-[#4B9CD3]"></i><h4 class="text-xs font-bold text-[#4B9CD3]">è¡Œç¨‹é‡é»æé†’</h4></div>
                        <button v-if="!isEditingTip" @click="startEditTip" class="p-1 text-white/30 hover:text-white/90 hover:bg-white/10 rounded-full transition-all"><i data-lucide="pencil" class="w-3 h-3"></i></button>
                    </div>
                    <div class="relative z-10 pl-6 border-l-2 border-[#4B9CD3]/30 ml-2">
                        <div v-if="!isEditingTip" class="text-xs opacity-90 leading-relaxed prose-tips" v-html="parsedTips"></div>
                        <div v-else class="animate-in fade-in duration-200">
                            <textarea v-model="tempTip" rows="5" class="w-full bg-black/20 text-white text-xs p-2 rounded-lg border border-white/20 focus:border-[#4B9CD3] outline-none mb-2 leading-relaxed" placeholder="å¯«é»ä»€éº¼æé†’è‡ªå·±å§..."></textarea>
                            <div class="flex gap-2 justify-end"><button @click="isEditingTip = false" class="px-3 py-1 text-[10px] text-gray-400 hover:text-white">å–æ¶ˆ</button><button @click="saveTip" class="px-3 py-1 bg-[#4B9CD3] text-[#433D3C] text-[10px] font-bold rounded-full hover:bg-white transition-colors">å„²å­˜</button></div>
                        </div>
                    </div>
                </div>

                <!-- å¤©æ°£å¡ç‰‡ -->
                <div class="bg-white border border-gray-100 p-4 rounded-2xl shadow-sm mb-2 relative overflow-hidden transition-all duration-300">
                    <div class="flex justify-between items-center mb-3 relative z-10">
                        <span class="text-xs font-bold text-gray-600 flex items-center gap-1"><i data-lucide="map-pin" class="w-3 h-3"></i> {{ currentDayData.location }}</span>
                        <span v-if="weatherState.status === 'loading'" class="text-[9px] bg-gray-100 text-gray-400 px-2 py-1 rounded-full flex items-center gap-1"><i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i> è®€å–ä¸­</span>
                        <span v-else-if="weatherState.status === 'too_early'" class="text-[9px] bg-gray-100 text-gray-400 px-2 py-1 rounded-full">å°šç„¡é å ±è³‡æ–™</span>
                        <span v-else class="text-[9px] bg-green-50 text-green-600 px-2 py-1 rounded-full border border-green-100 flex items-center gap-1"><i data-lucide="check-circle" class="w-3 h-3"></i> æ°£è±¡é å ±</span>
                    </div>
                    <div v-if="weatherState.status === 'available'" class="flex justify-between items-center text-center relative z-10 animate-in fade-in">
                        <div class="flex flex-col items-center"><span class="text-[10px] text-gray-400">æœ€ä½</span><i data-lucide="thermometer" class="w-5 h-5 text-blue-300 my-1"></i><span class="text-xs font-bold">{{ weatherState.data.min }}Â°</span></div>
                        <div class="w-[1px] h-6 bg-gray-100"></div>
                        <div class="flex flex-col items-center"><span class="text-[10px] text-gray-400">å¤©æ°£</span><i :data-lucide="getWeatherIcon(weatherState.data.code)" class="w-6 h-6 text-[#4B9CD3] my-1"></i><span class="text-xs font-bold">{{ weatherState.data.max }}Â° / {{ weatherState.data.min }}Â°</span></div>
                        <div class="w-[1px] h-6 bg-gray-100"></div>
                        <div class="flex flex-col items-center"><span class="text-[10px] text-gray-400">æœ€é«˜</span><i data-lucide="sun" class="w-5 h-5 text-orange-300 my-1"></i><span class="text-xs font-bold">{{ weatherState.data.max }}Â°</span></div>
                    </div>
                    <div v-else class="flex flex-col items-center justify-center py-4 text-gray-300 gap-2"><i data-lucide="calendar-clock" class="w-8 h-8 opacity-50"></i><span class="text-[10px]">è·é›¢å‡ºç™¼æ—¥æœŸè¼ƒé ï¼Œæš«ç„¡æº–ç¢ºé å ±</span></div>
                </div>
            </div>

            <!-- æ™‚é–“è»¸åˆ—è¡¨ (å«äº‹ä»¶ç·¨è¼¯) -->
            <div class="px-4 pb-20">
                <div class="relative pl-4 border-l-2 border-dashed border-gray-200 ml-2 space-y-6">
                    <div v-for="(event, eIdx) in currentDayData.events" :key="event.id" class="relative pl-6 group">
                        <div class="absolute -left-[9px] top-0 w-4 h-4 rounded-full border-2 border-[#FDFCF8] shadow-sm flex items-center justify-center bg-[#4B9CD3]"></div>
                        
                        <!-- é¡¯ç¤ºæ¨¡å¼ -->
                        <div v-if="editingEventId !== event.id">
                            <div class="text-xs font-mono font-bold text-[#4B9CD3] mb-1">{{ event.time }}</div>
                            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 hover:shadow-md transition-shadow relative">
                                <h3 class="font-bold text-gray-800 text-sm mb-1">{{ event.title }}</h3>
                                <p class="text-xs text-gray-500 mb-3">{{ event.sub }}</p>
                                <div class="flex gap-2 flex-wrap">
                                    <a v-if="event.mapUrl" :href="event.mapUrl" target="_blank" class="flex items-center gap-1 px-3 py-1.5 rounded-full bg-gray-800 text-white text-[10px] font-medium active:scale-95 transition-transform"><i data-lucide="navigation" class="w-3 h-3"></i> å°èˆª</a>
                                    <a v-else :href="`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(event.title + ' ' + event.sub)}`" target="_blank" class="flex items-center gap-1 px-3 py-1.5 rounded-full bg-gray-800 text-white text-[10px] font-medium active:scale-95 transition-transform"><i data-lucide="navigation" class="w-3 h-3"></i> å°èˆª</a>
                                    <button v-if="event.link" class="flex items-center gap-1 px-3 py-1.5 rounded-full border border-gray-200 text-gray-600 text-[10px] font-medium hover:bg-gray-50"><i data-lucide="external-link" class="w-3 h-3"></i> å®˜ç¶²</button>
                                    <button v-if="event.ticket" class="flex items-center gap-1 px-3 py-1.5 rounded-full bg-[#4B9CD3]/20 text-[#2C5282] text-[10px] font-medium"><i data-lucide="ticket" class="w-3 h-3"></i> æ†‘è­‰</button>
                                </div>
                                <div class="absolute top-2 right-2 flex gap-1">
                                    <button @click="startEditEvent(event)" class="text-gray-300 hover:text-blue-400 p-1"><i data-lucide="pencil" class="w-3.5 h-3.5"></i></button>
                                    <button @click="deleteEvent(eIdx)" class="text-gray-300 hover:text-red-400 p-1"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                                </div>
                            </div>
                        </div>

                        <!-- ç·¨è¼¯æ¨¡å¼ -->
                        <div v-else class="bg-white rounded-xl p-3 shadow-md border border-[#4B9CD3] animate-in fade-in">
                            <div class="space-y-2">
                                <div class="flex gap-2">
                                    <input v-model="tempEvent.time" class="w-1/3 bg-gray-50 border rounded px-2 py-1 text-xs" placeholder="æ™‚é–“">
                                    <input v-model="tempEvent.title" class="w-2/3 bg-gray-50 border rounded px-2 py-1 text-xs font-bold" placeholder="æ¨™é¡Œ">
                                </div>
                                <input v-model="tempEvent.sub" class="w-full bg-gray-50 border rounded px-2 py-1 text-xs" placeholder="åœ°é»/æè¿°">
                                <input v-model="tempEvent.mapUrl" class="w-full bg-gray-50 border rounded px-2 py-1 text-[10px]" placeholder="Google Maps é€£çµ (é¸å¡«)">
                                <div class="flex gap-2 text-[10px] text-gray-500">
                                    <label class="flex items-center gap-1"><input type="checkbox" v-model="tempEvent.link"> å®˜ç¶²</label>
                                    <label class="flex items-center gap-1"><input type="checkbox" v-model="tempEvent.ticket"> æ†‘è­‰</label>
                                </div>
                                <div class="flex gap-2 pt-1">
                                    <button @click="cancelEditEvent" class="flex-1 py-1.5 bg-gray-100 text-gray-500 rounded text-xs">å–æ¶ˆ</button>
                                    <button @click="saveEditEvent(eIdx)" class="flex-1 py-1.5 bg-[#4B9CD3] text-white rounded text-xs font-bold">å®Œæˆ</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button @click="addNewEvent" class="ml-6 w-[calc(100%-1.5rem)] py-3 border border-dashed border-gray-300 rounded-xl text-gray-400 text-xs hover:border-[#4B9CD3] hover:text-[#4B9CD3] transition-colors flex items-center justify-center gap-2"><i data-lucide="plus" class="w-3 h-3"></i> æ–°å¢è¡Œç¨‹</button>
                </div>
            </div>
        </div>

        <!-- VIEW: è¨˜å¸³åŠ©æ‰‹ (é›²ç«¯åŒæ­¥) -->
        <div v-if="currentView === 'expense'" class="h-full bg-[#FDFCF8] p-6 overflow-y-auto pb-safe">
            <div class="flex justify-between items-center mb-1">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2"><i data-lucide="wallet" class="w-6 h-6 text-[#4B9CD3]"></i> è¨˜å¸³åŠ©æ‰‹</h2>
                <div class="flex gap-2">
                    <span v-if="!dbConnected" class="text-[10px] text-gray-400 bg-gray-100 px-2 py-1 rounded-full flex items-center gap-1" title="è«‹è¨­å®š Firebase ä»¥å•Ÿç”¨é›²ç«¯åŠŸèƒ½"><i data-lucide="hard-drive" class="w-3 h-3"></i> æœ¬æ©Ÿ</span>
                    <span v-else class="text-[10px] text-green-600 bg-green-50 px-2 py-1 rounded-full flex items-center gap-1"><i data-lucide="cloud" class="w-3 h-3"></i> åŒæ­¥ä¸­</span>
                    <button @click="showSettlement" class="bg-gray-800 text-white text-[10px] px-3 py-1.5 rounded-full font-bold flex items-center gap-1 shadow-md active:scale-95 transition-transform">
                        <i data-lucide="calculator" class="w-3 h-3"></i> çµç®—
                    </button>
                </div>
            </div>
            <div class="flex items-center gap-1 mb-6">
                <p class="text-xs text-gray-400 font-mono">1 JPY â‰ˆ {{ exchangeRate }} TWD</p>
                <span v-if="isRateLoading" class="text-[10px] text-gray-300 animate-pulse">(æ›´æ–°ä¸­...)</span>
            </div>

            <!-- ç¸½èŠ±è²» -->
            <div class="bg-[#4B9CD3] rounded-3xl p-6 text-center shadow-lg shadow-blue-100 mb-8 relative overflow-hidden text-white">
                <div class="absolute -right-6 -top-6 w-24 h-24 bg-white opacity-20 rounded-full"></div>
                <div class="absolute -left-6 -bottom-6 w-20 h-20 bg-white opacity-20 rounded-full"></div>
                <div class="grid grid-cols-2 gap-4 relative z-10">
                    <div class="text-center border-r border-white/20"><p class="text-[10px] font-bold text-blue-100 uppercase tracking-widest mb-1 opacity-80">æ—¥å¹£æ”¯å‡º</p><h3 class="text-xl font-bold tracking-tight font-mono">Â¥{{ totalRealJPY.toLocaleString() }}</h3></div>
                    <div class="text-center"><p class="text-[10px] font-bold text-blue-100 uppercase tracking-widest mb-1 opacity-80">å°å¹£æ”¯å‡º</p><h3 class="text-xl font-bold tracking-tight font-mono">NT${{ totalRealTWD.toLocaleString() }}</h3></div>
                </div>
                <div class="mt-4 pt-4 border-t border-white/20 relative z-10"><div class="inline-block bg-black/10 px-3 py-1 rounded-full text-white/90 text-xs font-mono">ç¸½è¨ˆæŠ˜åˆç´„ NT$ {{ grandTotalInTWD.toLocaleString() }}</div></div>
            </div>

            <!-- è¼¸å…¥å€å¡Š -->
            <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm space-y-4">
                <input v-model="newExpense.title" placeholder="å“é … (å¦‚: é°»é­šé£¯)" class="w-full bg-gray-50 border-none rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-[#4B9CD3] outline-none">
                <div class="flex gap-2">
                    <div class="flex bg-gray-100 rounded-xl p-1 flex-shrink-0">
                        <button @click="newExpense.currency = 'JPY'" class="px-3 py-2 rounded-lg text-xs font-bold transition-all" :class="newExpense.currency === 'JPY' ? 'bg-white text-[#4B9CD3] shadow-sm' : 'text-gray-400'">Â¥</button>
                        <button @click="newExpense.currency = 'TWD'" class="px-3 py-2 rounded-lg text-xs font-bold transition-all" :class="newExpense.currency === 'TWD' ? 'bg-white text-[#4B9CD3] shadow-sm' : 'text-gray-400'">NT$</button>
                    </div>
                    <input v-model="newExpense.amount" type="number" placeholder="é‡‘é¡" class="flex-1 bg-gray-50 border-none rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-[#4B9CD3] outline-none font-mono">
                </div>
                <div class="bg-gray-50 rounded-xl p-3 space-y-3">
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-bold text-gray-500 w-16">èª°å…ˆä»˜éŒ¢</span>
                        <select v-model="newExpense.payer" class="bg-white border border-gray-200 rounded-lg px-3 py-1.5 text-xs text-gray-700 outline-none flex-1"><option v-for="member in members" :key="member" :value="member">{{ member }}</option><option value="å…¬è²»">å…¬è²»æ”¯å‡º</option></select>
                    </div>
                    <div class="flex items-start gap-2">
                        <span class="text-xs font-bold text-gray-500 w-16 mt-1.5">åˆ†çµ¦èª°</span>
                        <div class="flex-1 flex flex-wrap gap-2">
                            <button @click="toggleAllSplitters(newExpense)" class="px-2 py-1 rounded-md text-[10px] border transition-colors" :class="newExpense.splitters.length === members.length ? 'bg-[#4B9CD3] text-white border-[#4B9CD3]' : 'bg-white text-gray-400 border-gray-200'">å…¨é¸</button>
                            <button v-for="member in members" :key="member" @click="toggleSplitter(newExpense, member)" class="px-2 py-1 rounded-md text-[10px] border transition-colors" :class="newExpense.splitters.includes(member) ? 'bg-gray-700 text-white border-gray-700' : 'bg-white text-gray-500 border-gray-200'">{{ member }}</button>
                        </div>
                    </div>
                </div>
                <button @click="addExpense" class="w-full bg-[#433D3C] text-[#4B9CD3] font-bold py-3 rounded-xl text-sm shadow-md hover:bg-black transition-colors">æ–°å¢ç´€éŒ„</button>
            </div>

            <!-- åˆ—è¡¨ -->
            <div class="mt-6 space-y-3 pb-20">
                <h4 class="text-xs font-bold text-gray-400 pl-1">è¿‘æœŸæ”¯å‡º</h4>
                <div v-if="expenses.length === 0" class="text-center text-gray-300 text-xs py-4">ç›®å‰æ²’æœ‰ç´€éŒ„</div>
                <div v-for="ex in expenses" :key="ex.id" class="bg-white p-4 rounded-xl border border-gray-50 transition-all">
                    <div v-if="editingExpenseId !== ex.id" class="flex justify-between items-center group">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-xs text-gray-500 font-bold flex-shrink-0">{{ ex.payer[0] }}</div>
                            <div>
                                <div class="text-sm font-bold text-gray-800">{{ ex.title }}</div>
                                <div class="text-[10px] text-gray-400 flex flex-col"><span>{{ ex.date }} â€¢ {{ ex.payer }} å…ˆä»˜</span><span class="text-gray-300 text-[9px] mt-0.5" v-if="ex.splitters && ex.splitters.length < members.length">åˆ†çµ¦: {{ ex.splitters.join(', ') }}</span></div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="text-right"><div class="text-sm font-bold text-gray-800 font-mono">{{ ex.currency === 'JPY' ? 'Â¥' : 'NT$' }} {{ Number(ex.amount).toLocaleString() }}</div></div>
                            <div class="flex flex-col gap-1"><button @click="startEditExpense(ex)" class="text-gray-300 hover:text-blue-500"><i data-lucide="edit-2" class="w-3.5 h-3.5"></i></button><button @click="deleteExpense(ex.id)" class="text-gray-300 hover:text-red-500"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button></div>
                        </div>
                    </div>
                    <!-- æ”¯å‡ºç·¨è¼¯æ¨¡å¼ -->
                    <div v-else class="space-y-3">
                        <div class="flex justify-between items-center mb-2"><span class="text-xs font-bold text-[#4B9CD3]">ç·¨è¼¯æ”¯å‡º</span></div>
                        <input v-model="tempExpense.title" class="w-full bg-gray-50 border-none rounded-lg px-3 py-2 text-xs" placeholder="å“é …">
                        <div class="flex gap-2"><div class="flex bg-gray-100 rounded-lg p-0.5"><button @click="tempExpense.currency = 'JPY'" class="px-2 py-1.5 rounded-md text-[10px] font-bold" :class="tempExpense.currency === 'JPY' ? 'bg-white text-[#4B9CD3]' : 'text-gray-400'">Â¥</button><button @click="tempExpense.currency = 'TWD'" class="px-2 py-1.5 rounded-md text-[10px] font-bold" :class="tempExpense.currency === 'TWD' ? 'bg-white text-[#4B9CD3]' : 'text-gray-400'">NT$</button></div><input v-model="tempExpense.amount" class="flex-1 bg-gray-50 border-none rounded-lg px-3 py-2 text-xs font-mono"></div>
                        <div class="flex gap-2">
                            <select v-model="tempExpense.payer" class="bg-gray-50 rounded-lg px-3 py-2 text-xs text-gray-600 outline-none flex-1"><option v-for="member in members" :key="member" :value="member">{{ member }}</option><option value="å…¬è²»">å…¬è²»æ”¯å‡º</option></select>
                            <div class="flex gap-1"><button @click="cancelEditExpense" class="px-3 py-1.5 bg-gray-100 text-gray-500 rounded-lg text-xs font-bold">å–æ¶ˆ</button><button @click="saveEditExpense" class="px-3 py-1.5 bg-[#433D3C] text-[#4B9CD3] rounded-lg text-xs font-bold">å„²å­˜</button></div>
                        </div>
                        <div class="flex items-start gap-2 bg-gray-50 p-2 rounded-lg"><span class="text-[10px] font-bold text-gray-500 w-10 mt-1">åˆ†æ”¤</span><div class="flex-1 flex flex-wrap gap-1"><button @click="toggleAllSplitters(tempExpense)" class="px-2 py-0.5 rounded text-[10px] border" :class="tempExpense.splitters.length === members.length ? 'bg-[#4B9CD3] text-white' : 'bg-white text-gray-400'">å…¨</button><button v-for="m in members" :key="m" @click="toggleSplitter(tempExpense, m)" class="px-2 py-0.5 rounded text-[10px] border" :class="tempExpense.splitters.includes(m) ? 'bg-gray-700 text-white' : 'bg-white text-gray-500'">{{ m }}</button></div></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: è¨­å®š (Rate Only) -->
        <div v-if="currentView === 'settings'" class="h-full bg-[#FDFCF8] p-6 overflow-y-auto">
            <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                <i data-lucide="settings" class="w-6 h-6 text-[#4B9CD3]"></i> è¨­å®š
            </h2>
            <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm">
                <h3 class="text-sm font-bold text-gray-700 mb-2">åŒ¯ç‡è¨­å®š</h3>
                <div class="flex items-center gap-3">
                    <span class="text-xs text-gray-500">1 JPY = </span>
                    <input type="number" v-model="exchangeRate" step="0.001" class="w-24 bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-xs text-center outline-none focus:border-[#4B9CD3]">
                    <span class="text-xs text-gray-500">TWD</span>
                </div>
                <button @click="fetchExchangeRate" class="mt-2 text-[10px] text-blue-500 underline flex items-center gap-1"><i data-lucide="refresh-cw" class="w-3 h-3" :class="{'animate-spin': isRateLoading}"></i> æŠ“å–å³æ™‚åŒ¯ç‡</button>
            </div>
            <p v-if="dbConnected" class="text-[10px] text-green-500 mt-4 flex items-center gap-1 justify-center"><i data-lucide="check" class="w-3 h-3"></i> Firebase é€£ç·šæ­£å¸¸ (Nagoya 2026)</p>
        </div>

        <!-- Settlement Modal -->
        <div v-if="showSettlementModal" class="fixed inset-0 z-50 flex items-center justify-center p-4">
            <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" @click="showSettlementModal = false"></div>
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 relative z-10 animate-in fade-in zoom-in duration-200 max-h-[90vh] overflow-y-auto">
                <button @click="showSettlementModal = false" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button>
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2"><i data-lucide="calculator" class="w-5 h-5 text-[#4B9CD3]"></i> é›™å¹£çµç®—å ±å‘Š</h3>
                <div class="space-y-4 mb-6">
                    <div v-for="stat in settlementStats" :key="stat.name" class="flex flex-col text-xs border-b border-gray-50 pb-2">
                        <div class="flex justify-between items-center mb-1"><span class="font-bold text-gray-800 text-sm">{{ stat.name }}</span></div>
                        <div class="flex justify-between"><span class="text-gray-400">æ—¥å¹£æ·¨é¡</span><span class="font-mono font-bold" :class="stat.netJPY >= 0 ? 'text-green-500' : 'text-red-500'">{{ stat.netJPY >= 0 ? 'æ”¶' : 'ä»˜' }} Â¥{{ Math.abs(stat.netJPY).toLocaleString() }}</span></div>
                        <div class="flex justify-between"><span class="text-gray-400">å°å¹£æ·¨é¡</span><span class="font-mono font-bold" :class="stat.netTWD >= 0 ? 'text-green-500' : 'text-red-500'">{{ stat.netTWD >= 0 ? 'æ”¶' : 'ä»˜' }} ${{ Math.abs(stat.netTWD).toLocaleString() }}</span></div>
                    </div>
                </div>
                <div class="bg-gray-50 rounded-2xl p-4 mb-3"><h4 class="text-xs font-bold text-gray-500 mb-3 uppercase tracking-wider flex items-center gap-1"><i data-lucide="coins" class="w-3 h-3"></i> æ—¥å¹£è½‰å¸³å»ºè­°</h4><div v-if="transfersJPY.length === 0" class="text-center text-gray-400 text-xs py-1">ç„¡æ—¥å¹£å¸³æ¬¾</div><div v-else class="space-y-2"><div v-for="(transfer, idx) in transfersJPY" :key="idx" class="flex items-center justify-between bg-white p-2 rounded-lg border border-gray-100 shadow-sm"><div class="flex items-center gap-2"><span class="font-bold text-gray-800 text-xs">{{ transfer.from }}</span><i data-lucide="arrow-right" class="w-3 h-3 text-gray-300"></i><span class="font-bold text-gray-800 text-xs">{{ transfer.to }}</span></div><span class="font-mono font-bold text-[#4B9CD3] text-xs">Â¥{{ transfer.amount.toLocaleString() }}</span></div></div></div>
                <div class="bg-gray-50 rounded-2xl p-4"><h4 class="text-xs font-bold text-gray-500 mb-3 uppercase tracking-wider flex items-center gap-1"><i data-lucide="banknote" class="w-3 h-3"></i> å°å¹£è½‰å¸³å»ºè­°</h4><div v-if="transfersTWD.length === 0" class="text-center text-gray-400 text-xs py-1">ç„¡å°å¹£å¸³æ¬¾</div><div v-else class="space-y-2"><div v-for="(transfer, idx) in transfersTWD" :key="idx" class="flex items-center justify-between bg-white p-2 rounded-lg border border-gray-100 shadow-sm"><div class="flex items-center gap-2"><span class="font-bold text-gray-800 text-xs">{{ transfer.from }}</span><i data-lucide="arrow-right" class="w-3 h-3 text-gray-300"></i><span class="font-bold text-gray-800 text-xs">{{ transfer.to }}</span></div><span class="font-mono font-bold text-[#4B9CD3] text-xs">${{ transfer.amount.toLocaleString() }}</span></div></div></div>
                <button @click="showSettlementModal = false" class="w-full mt-6 bg-[#433D3C] text-white py-3 rounded-xl font-bold text-sm">é—œé–‰</button>
            </div>
        </div>

        <!-- VIEW: ç·Šæ€¥æ±‚åŠ© -->
        <div v-if="currentView === 'emergency'" class="h-full bg-[#433D3C] text-white p-6 overflow-y-auto">
             <h2 class="text-2xl font-bold mb-2 flex items-center gap-2 text-red-400">
                <i data-lucide="plus-square" class="w-6 h-6"></i> ç·Šæ€¥æ±‚åŠ©
            </h2>
            <div class="space-y-4">
                <a href="tel:110" class="block bg-red-900/30 border border-red-900/50 p-5 rounded-2xl flex items-center justify-between active:scale-95 transition-transform">
                    <div>
                        <h3 class="text-lg font-bold text-red-400 mb-1">è­¦å¯Ÿå±€</h3>
                        <p class="text-xs text-red-200/60">çŠ¯ç½ªã€äº‹æ•…ã€éºå¤±ç‰©å“</p>
                    </div>
                    <div class="bg-red-500 text-white px-5 py-2 rounded-full font-bold flex items-center gap-2 shadow-lg shadow-red-900/50">
                        <i data-lucide="phone" class="w-4 h-4"></i> 110
                    </div>
                </a>
                <a href="tel:119" class="block bg-orange-900/30 border border-orange-900/50 p-5 rounded-2xl flex items-center justify-between active:scale-95 transition-transform">
                    <div>
                        <h3 class="text-lg font-bold text-orange-400 mb-1">æ•‘è­·è»Š / æ¶ˆé˜²</h3>
                        <p class="text-xs text-orange-200/60">å—å‚·ã€æ€¥ç—…ã€ç«ç½</p>
                    </div>
                    <div class="bg-orange-500 text-white px-5 py-2 rounded-full font-bold flex items-center gap-2 shadow-lg shadow-orange-900/50">
                        <i data-lucide="phone" class="w-4 h-4"></i> 119
                    </div>
                </a>
                <a href="tel:+81661201001" class="block bg-blue-900/30 border border-blue-900/50 p-5 rounded-2xl flex items-center justify-between active:scale-95 transition-transform">
                    <div>
                        <h3 class="text-lg font-bold text-blue-400 mb-1">å°åŒ—é§å¤§é˜ªè¾¦äº‹è™•</h3>
                        <p class="text-xs text-blue-200/60">è­·ç…§éºå¤±ã€æ€¥é›£æ•‘åŠ©</p>
                    </div>
                    <div class="bg-blue-500 text-white px-5 py-2 rounded-full font-bold flex items-center gap-2 shadow-lg shadow-blue-900/50">
                        <i data-lucide="phone" class="w-4 h-4"></i> æ’¥æ‰“
                    </div>
                </a>
            </div>
        </div>

    </main>
</div>

<script type="module">
    const { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, query, setDoc, getDoc } = window.firebaseModules;
    const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

    createApp({
        setup() {
            const currentView = ref('itinerary');
            const activeDayIndex = ref(0);
            const exchangeRate = ref(0.22);
            const isRateLoading = ref(false);
            
            // ç·¨è¼¯ç›¸é—œ
            const isEditingTip = ref(false);
            const tempTip = ref('');
            const editingEventId = ref(null);
            const tempEvent = ref({});
            const editingExpenseId = ref(null);
            const tempExpense = ref({});
            const isEditingTitle = ref(false);
            const tempTitle = ref({title: '', desc: ''});

            // è¨˜å¸³èˆ‡è¨­å®š
            const dbConnected = ref(false);
            const showSettlementModal = ref(false);
            const settlementStats = ref([]);
            const transfersJPY = ref([]);
            const transfersTWD = ref([]);
            const weatherState = ref({ status: 'loading', data: null });

            const members = ref(['å“è±1', 'å“è±2', 'å“è±3', 'OY1', 'OY2', 'OY3', 'OY4', 'RUBY1', 'RUBY2']);
            const expenses = ref([]);
            const newExpense = ref({ title: '', amount: '', payer: 'OY', currency: 'JPY', splitters: [...members.value] });

            // ğŸ”´ ä½ çš„ Firebase Config (å¯«æ­»åœ¨ç¨‹å¼ç¢¼è£¡ï¼Œæ–¹ä¾¿å¤§å®¶ä½¿ç”¨)
            const myFirebaseConfig = {
                apiKey: "AIzaSyDPsTLpK7VaGgJoZk3_Kmqzjia-rOR5fNY",
                authDomain: "hokkaido-trip-f44e9.firebaseapp.com",
                projectId: "hokkaido-trip-f44e9",
                storageBucket: "hokkaido-trip-f44e9.firebasestorage.app",
                messagingSenderId: "592554790310",
                appId: "1:592554790310:web:b50f36effd908a872d9367",
                measurementId: "G-36BG8FB13C"
            };

            // åå¤å±‹ 2026 è¡Œç¨‹è³‡æ–™
            const defaultItinerary = [
                { 
                    date: "1/7 (ä¸‰)", shortDate: "1/7", title: "åˆè¦‹åå¤å±‹ & è³¼ç‰©æ—¥", 
                    desc: "æŠµé”ä¸­éƒ¨åœ‹éš›æ©Ÿå ´ï¼Œå¸‚å€è³¼ç‰©ï¼Œå…¥ä½æº«é¦¨æ°‘å®¿ã€‚", location: "åå¤å±‹", lat: 35.1815, lon: 136.9066, tags: ["å¯¶å¯å¤¢", "HARBS", "é°»é­šé£¯"],
                    tips: "âš ï¸ æ©Ÿå ´å‡ºç™¼ç´„ 40-50 åˆ†é˜ã€‚\nğŸ›ï¸ Parco æœ‰å¯¶å¯å¤¢ä¸­å¿ƒå’Œ HARBS è›‹ç³•ã€‚\nğŸ  æ°‘å®¿åœ°å€ï¼šYonchÅda-801-10 ShippÅchÅ Akitake, Ama, Aichi\nğŸ½ï¸ æ™šé¤ï¼šã‚ã¤ãŸè“¬è±è»’(é°»é­šé£¯) æˆ– çŸ¢å ´å‘³å™Œè±¬æ’ã€‚",
                    events: [
                        { id: 1, time: "07:35", title: "æŠµé”æ©Ÿå ´", sub: "11:03 é™è½ NGO", link: false, ticket: true },
                        { id: 2, time: "12:30", title: "æ©Ÿå ´å‡ºç™¼", sub: "åŒ…è»Šå‰å¾€å¸‚å€", link: false, ticket: false },
                        { id: 3, time: "13:20", title: "Nagoya PARCO", sub: "å¯¶å¯å¤¢/HARBS", link: true, ticket: false },
                        { id: 4, time: "16:30", title: "å‰å¾€æ°‘å®¿", sub: "åŒ…è»Šç§»å‹•", link: false, ticket: false },
                        { id: 5, time: "17:10", title: "æ°‘å®¿ Check-in", sub: "Ama, Aichi", mapUrl: "https://maps.google.com/?q=YonchÅda-801-10+ShippÅchÅ+Akitake", link: false, ticket: true }
                    ]
                },
                { 
                    date: "1/8 (å››)", shortDate: "1/8", title: "é¾è²“èˆ‡å‰åœåŠ›çš„é­”æ³•", 
                    desc: "å‰åœåŠ›å…¬åœ’å…¨æ—¥éŠï¼Œé€²å…¥å¤¢å¹»å‹•ç•«ä¸–ç•Œã€‚", location: "é•·ä¹…æ‰‹", lat: 35.1709, lon: 137.0867, tags: ["å‰åœåŠ›", "é¾è²“", "è¦ªå­"],
                    tips: "ğŸƒ å‰åœåŠ›å…¬åœ’æ²’æœ‰éŠæ¨‚è¨­æ–½ï¼Œä¸»è¦æ˜¯å ´æ™¯é‚„åŸã€‚\nğŸ” åˆé¤ï¼šåœ’å€é¤è»Šæˆ–æ‘©æ–¯æ¼¢å ¡ã€‚\nğŸ½ï¸ æ™šé¤ï¼šSteak House Asakuma (æœ‰è‡ªåŠ©å§ï¼Œé©åˆå°å­©)ã€‚",
                    events: [
                        { id: 6, time: "09:00", title: "æ°‘å®¿å‡ºç™¼", sub: "å‰å¾€å‰åœåŠ›", link: false, ticket: false },
                        { id: 7, time: "10:00", title: "å‰åœåŠ›å…¬åœ’", sub: "Ghibli Park", link: true, ticket: true },
                        { id: 8, time: "16:00", title: "è¿”å›å¸‚å€", sub: "å¾€é¤å»³ç§»å‹•", link: false, ticket: false },
                        { id: 9, time: "17:00", title: "æ™šé¤", sub: "Steak House Asakuma", link: true, ticket: false }
                    ]
                },
                { 
                    date: "1/9 (äº”)", shortDate: "1/9", title: "æµ·æ´‹ä¸–ç•Œ & è¦ªå­è³¼ç‰©", 
                    desc: "åå¤å±‹æ¸¯æ°´æ—é¤¨çœ‹è™é¯¨ï¼Œä¸‹åˆ LaLaport è³¼ç‰©ã€‚", location: "åå¤å±‹æ¸¯", lat: 35.0906, lon: 136.8781, tags: ["æ°´æ—é¤¨", "è™é¯¨", "é˜¿å¡å°‡"],
                    tips: "ğŸ¬ å¿…çœ‹æµ·è±šç§€å’Œè™é¯¨è¡¨æ¼”ã€‚\nğŸŸ åˆé¤åœ¨æ¼æ¸¯åƒæ–°é®®æµ·é®®ã€‚\nğŸ›ï¸ LaLaport æœ‰é˜¿å¡å°‡æœ¬èˆ–(æ¯å¬°ç”¨å“)å’Œ Loftã€‚",
                    events: [
                        { id: 10, time: "09:30", title: "æ°‘å®¿å‡ºç™¼", sub: "å‰å¾€æ°´æ—é¤¨", link: false, ticket: false },
                        { id: 11, time: "10:10", title: "åå¤å±‹æ¸¯æ°´æ—é¤¨", sub: "æµ·è±šç§€/è™é¯¨", link: false, ticket: true },
                        { id: 12, time: "12:30", title: "åˆé¤", sub: "æ¼æ¸¯", link: false, ticket: false },
                        { id: 13, time: "13:45", title: "LaLaport", sub: "è³¼ç‰©/æ™šé¤", link: true, ticket: false }
                    ]
                },
                { 
                    date: "1/10 (å…­)", shortDate: "1/10", title: "æ¨‚é«˜æ¨‚åœ’ç˜‹ç©æ—¥", 
                    desc: "LEGOLAND Japan å…¨æ—¥æš¢ç©ã€‚", location: "é‡‘åŸãµé ­", lat: 35.0507, lon: 136.8436, tags: ["æ¨‚é«˜", "éŠæ¨‚åœ’"],
                    tips: "ğŸ§± æ—¥æœ¬æ¨‚é«˜æ¨‚åœ’ï¼Œé©åˆ 2-12 æ­²å°å­©ã€‚\nğŸŸ åˆé¤åœ¨æ¨‚åœ’å…§è§£æ±ºã€‚",
                    events: [
                        { id: 14, time: "09:00", title: "æ°‘å®¿å‡ºç™¼", sub: "å‰å¾€æ¨‚é«˜æ¨‚åœ’", link: false, ticket: false },
                        { id: 15, time: "09:30", title: "LEGOLAND", sub: "å…¨æ—¥æš¢ç©", link: true, ticket: true },
                        { id: 16, time: "18:00", title: "æ™šé¤", sub: "å¸‚å€æˆ–æ°‘å®¿é™„è¿‘", link: false, ticket: false }
                    ]
                },
                { 
                    date: "1/11 (æ—¥)", shortDate: "1/11", title: "å’Œæœé«”é©— & å¤§é ˆå•†åº—è¡—", 
                    desc: "å…¨å®¶ç©¿å’Œæœæ‹ç…§ï¼Œé€›å¤§é ˆè§€éŸ³èˆ‡å•†åº—è¡—ã€‚", location: "å¤§é ˆ", lat: 35.1598, lon: 136.9019, tags: ["å’Œæœ", "å¤§é ˆ", "é£›é¨¨ç‰›"],
                    tips: "ğŸ‘˜ 10:00 Vasara åå¤å±‹è»Šç«™åº—æ›å’Œæœã€‚\nğŸ“¸ å¤§é ˆè§€éŸ³æœ‰å·¨å‹æ‹›è²¡è²“ï¼Œé©åˆæ‹ç…§ã€‚\nğŸ¥© æ™šé¤é ç´„ï¼šé£›é¨¨ç‰›ä¸€é ­å®¶ é¦¬å–°ä¸€ä»£ WESTã€‚",
                    events: [
                        { id: 17, time: "09:00", title: "æ°‘å®¿å‡ºç™¼", sub: "å‰å¾€ Vasara", link: false, ticket: false },
                        { id: 18, time: "10:00", title: "å’Œæœé«”é©—", sub: "Vasara åå¤å±‹ç«™", link: true, ticket: true },
                        { id: 19, time: "12:00", title: "å¤§é ˆå•†åº—è¡—", sub: "é€›è¡—/åˆé¤", link: true, ticket: false },
                        { id: 20, time: "16:00", title: "æ­¸é‚„å’Œæœ", sub: "è»Šç«™æ¡è²·", link: false, ticket: false },
                        { id: 21, time: "18:00", title: "æ™šé¤", sub: "é¦¬å–°ä¸€ä»£ WEST", link: true, ticket: true }
                    ]
                },
                { 
                    date: "1/12 (ä¸€)", shortDate: "1/12", title: "å¿«æ¨‚è³¦æ­¸", 
                    desc: "å‰å¾€æ©Ÿå ´ï¼Œæœ€å¾Œæ¡è²·ï¼Œæº–å‚™æ­æ©Ÿã€‚", location: "ä¸­éƒ¨æ©Ÿå ´", lat: 34.8588, lon: 136.8146, tags: ["è¦é¤…", "æ³¢éŸ³787"], 
                    tips: "ğŸš 08:30 æº–æ™‚ Check-out ç™¼è»Šã€‚\nâœˆï¸ å»ºè­° 09:30-10:00 æŠµé”æ©Ÿå ´ã€‚\nğŸ¦ 4æ¨“è—å¤©åŸè²·è¦é¤…ä¹‹é‡Œ (ãˆã³ã›ã‚“ã¹ã„ã®é‡Œ)ã€‚\nğŸ›« 12:05 èµ·é£›ã€‚",
                    events: [
                        { id: 22, time: "08:30", title: "æ°‘å®¿ Check-out", sub: "æº–æ™‚ç™¼è»Š", link: false, ticket: false },
                        { id: 23, time: "09:30", title: "æŠµé”æ©Ÿå ´", sub: "è¾¦ç†ç™»æ©Ÿ", link: false, ticket: true },
                        { id: 24, time: "10:30", title: "æ©Ÿå ´å·¡ç¦®", sub: "è¦é¤…/æ³¢éŸ³787", link: false, ticket: false },
                        { id: 25, time: "12:05", title: "èµ·é£›", sub: "å›æº«æš–çš„å®¶", link: false, ticket: true }
                    ] 
                }
            ];
            
            const itinerary = ref([...defaultItinerary]); 

            // Computed
            const currentDayData = computed(() => itinerary.value[activeDayIndex.value]);
            const totalRealJPY = computed(() => expenses.value.filter(e => e.currency === 'JPY').reduce((sum, e) => sum + Number(e.amount), 0));
            const totalRealTWD = computed(() => expenses.value.filter(e => e.currency === 'TWD').reduce((sum, e) => sum + Number(e.amount), 0));
            const grandTotalInTWD = computed(() => Math.round(totalRealTWD.value + totalRealJPY.value * exchangeRate.value));
            const targetDate = new Date('2026-01-07'); // Set target date to Nagoya Trip start
            const daysRemaining = computed(() => { const today = new Date(); return Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24)); });
            const parsedTips = computed(() => marked.parse(currentDayData.value.tips || ''));

            // Firebase Logic
            let db;
            // âš ï¸ é€™è£¡ä½¿ç”¨ 'nagoya_2026' ä½œç‚ºæ–‡ä»¶ IDï¼Œç¢ºä¿ä¸æœƒè®€å–åˆ°èˆŠçš„åŒ—æµ·é“è³‡æ–™
            const collectionId = 'nagoya_2026'; 

            const initFirebase = () => {
                if (myFirebaseConfig.apiKey) {
                    try {
                        const app = initializeApp(myFirebaseConfig);
                        const auth = getAuth(app);
                        db = getFirestore(app);

                        signInAnonymously(auth);
                        onAuthStateChanged(auth, (user) => {
                            if (user) {
                                dbConnected.value = true;
                                // 1. ç›£è½è¨˜å¸³ (ä½¿ç”¨ç¨ç«‹çš„ collection ä»¥å…æ··æ·†)
                                onSnapshot(collection(db, 'expenses_nagoya'), (snap) => {
                                    expenses.value = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => b.createdAt - a.createdAt);
                                });
                                // 2. ç›£è½è¡Œç¨‹
                                onSnapshot(doc(db, 'plans', collectionId), (docSnap) => {
                                    if (docSnap.exists()) {
                                        itinerary.value = docSnap.data().days;
                                    } else {
                                        // å¦‚æœé›²ç«¯æ²’è³‡æ–™ (ç¬¬ä¸€æ¬¡ç”¨)ï¼ŒæŠŠé è¨­çš„åå¤å±‹è³‡æ–™å¯«ä¸Šå»
                                        setDoc(doc(db, 'plans', collectionId), { days: defaultItinerary });
                                    }
                                });
                            }
                        });
                    } catch (e) { console.error("Firebase Init Failed", e); alert("Firebase é€£ç·šå¤±æ•—"); }
                }
            };
            
            // Sync Itinerary to Firebase
            const saveItinerary = () => {
                if (dbConnected.value) {
                    setDoc(doc(db, 'plans', collectionId), { days: itinerary.value });
                }
            };

            // Events Handling
            const switchDay = (i) => { currentView.value = 'itinerary'; activeDayIndex.value = i; isEditingTip.value = false; isEditingTitle.value = false; };
            const getDayIcon = (i) => i === 0 || i === 5 ? 'plane' : (i === 1 || i === 4 ? 'camera' : (i === 3 ? 'gamepad-2' : 'map-pin'));
            const getWeatherIcon = (w) => w === 'snow' ? 'snowflake' : (w === 'sun' ? 'sun' : 'cloud');
            
            // Edit Title/Desc
            const startEditTitle = () => { tempTitle.value = {title: currentDayData.value.title, desc: currentDayData.value.desc}; isEditingTitle.value = true; };
            const saveTitle = () => { 
                itinerary.value[activeDayIndex.value].title = tempTitle.value.title; 
                itinerary.value[activeDayIndex.value].desc = tempTitle.value.desc;
                isEditingTitle.value = false;
                saveItinerary();
            };

            // Edit Itinerary Event
            const startEditEvent = (e) => { editingEventId.value = e.id; tempEvent.value = {...e}; };
            const cancelEditEvent = () => { editingEventId.value = null; tempEvent.value = {}; };
            const saveEditEvent = (idx) => { 
                itinerary.value[activeDayIndex.value].events[idx] = {...tempEvent.value}; 
                editingEventId.value = null; 
                saveItinerary();
            };
            const addNewEvent = () => {
                itinerary.value[activeDayIndex.value].events.push({ id: Date.now(), time: "12:00", title: "æ–°è¡Œç¨‹", sub: "åœ°é»", link: false, ticket: false });
                saveItinerary();
            };
            const deleteEvent = (idx) => { 
                if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) {
                    itinerary.value[activeDayIndex.value].events.splice(idx, 1);
                    saveItinerary();
                }
            };
            
            // Tips Editing
            const startEditTip = () => { tempTip.value = currentDayData.value.tips; isEditingTip.value = true; };
            const saveTip = () => { 
                itinerary.value[activeDayIndex.value].tips = tempTip.value; 
                isEditingTip.value = false; 
                saveItinerary();
            };

            // Expense Logic
            const addExpense = async () => {
                if (!newExpense.value.title) return;
                const data = { ...newExpense.value, amount: Number(newExpense.value.amount), date: new Date().toLocaleDateString('zh-TW'), createdAt: Date.now() };
                if (dbConnected.value) await addDoc(collection(db, 'expenses_nagoya'), data);
                else expenses.value.unshift({ id: Date.now(), ...data });
                newExpense.value.title = ''; newExpense.value.amount = '';
            };
            const deleteExpense = async (id) => { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) dbConnected.value ? await deleteDoc(doc(db, 'expenses_nagoya', id)) : expenses.value = expenses.value.filter(e => e.id !== id); };
            const startEditExpense = (ex) => { editingExpenseId.value = ex.id; tempExpense.value = JSON.parse(JSON.stringify(ex)); };
            const saveEditExpense = async () => {
                const { id, ...data } = tempExpense.value;
                if (dbConnected.value) await updateDoc(doc(db, 'expenses_nagoya', id), data);
                else { const idx = expenses.value.findIndex(e => e.id === id); if(idx !== -1) expenses.value[idx] = { id, ...data }; }
                editingExpenseId.value = null;
            };
            const cancelEditExpense = () => editingExpenseId.value = null;
            const toggleSplitter = (obj, m) => { const idx = obj.splitters.indexOf(m); idx > -1 ? obj.splitters.splice(idx, 1) : obj.splitters.push(m); };
            const toggleAllSplitters = (obj) => { obj.splitters = obj.splitters.length === members.value.length ? [] : [...members.value]; };

            const calculateSettlement = () => {
                let debtsJPY = {}, debtsTWD = {}; members.value.forEach(m => { debtsJPY[m] = 0; debtsTWD[m] = 0; });
                expenses.value.forEach(ex => {
                    if (ex.payer === 'å…¬è²»') return;
                    if (ex.splitters && ex.splitters.length > 0) {
                        let amount = Math.round(ex.amount / ex.splitters.length);
                        if (ex.currency === 'JPY') { debtsJPY[ex.payer] += ex.amount; ex.splitters.forEach(s => debtsJPY[s] -= amount); } 
                        else { debtsTWD[ex.payer] += ex.amount; ex.splitters.forEach(s => debtsTWD[s] -= amount); }
                    }
                });
                settlementStats.value = members.value.map(m => ({ name: m, netJPY: debtsJPY[m], netTWD: debtsTWD[m] }));
                const getTransfers = (debts) => {
                    let debtors = [], creditors = [], results = [];
                    for (const [name, amount] of Object.entries(debts)) { if (amount < -1) debtors.push({ name, amount }); if (amount > 1) creditors.push({ name, amount }); }
                    debtors.sort((a, b) => a.amount - b.amount); creditors.sort((a, b) => b.amount - a.amount);
                    let i = 0, j = 0;
                    while (i < debtors.length && j < creditors.length) {
                        let amount = Math.min(Math.abs(debtors[i].amount), creditors[j].amount);
                        if (amount > 0) results.push({ from: debtors[i].name, to: creditors[j].name, amount });
                        debtors[i].amount += amount; creditors[j].amount -= amount;
                        if (Math.abs(debtors[i].amount) < 1) i++; if (creditors[j].amount < 1) j++;
                    }
                    return results;
                };
                transfersJPY.value = getTransfers(debtsJPY); transfersTWD.value = getTransfers(debtsTWD);
                showSettlementModal.value = true;
            };
            
            // Add/Remove Day (Synced)
            const addNewDay = () => {
                const startDate = new Date('2026-01-07');
                const nextDate = new Date(startDate);
                nextDate.setDate(startDate.getDate() + itinerary.value.length);
                const dayOfWeek = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][nextDate.getDay()];
                const formattedDate = `${nextDate.getMonth() + 1}/${nextDate.getDate()} (${dayOfWeek})`;
                const shortDate = `${nextDate.getMonth() + 1}/${nextDate.getDate()}`;
                itinerary.value.push({ date: formattedDate, shortDate: shortDate, title: "è‡ªç”±å®‰æ’", desc: "æ–°çš„ä¸€å¤©", location: "å¾…å®š", temp: 0, tempLow: 0, tempHigh: 0, weather: "sun", tags: [], tips: "é»æ“Šç·¨è¼¯å¡«å¯«", events: [] });
                saveItinerary();
                switchDay(itinerary.value.length - 1);
            };
            const removeLastDay = () => { 
                if (itinerary.value.length > 1 && confirm("åˆªé™¤æœ€å¾Œä¸€å¤©ï¼Ÿ")) {
                    itinerary.value.pop();
                    saveItinerary();
                }
            };
            
            const fetchExchangeRate = async () => { isRateLoading.value = true; try { const res = await fetch('https://api.exchangerate-api.com/v4/latest/JPY'); const data = await res.json(); if(data.rates) exchangeRate.value = data.rates.TWD; } catch {} finally { isRateLoading.value = false; } };
            
            const fetchRealTimeWeather = async () => {
                const day = currentDayData.value;
                if (!day.lat) { weatherState.value = { status: 'too_early', data: null }; return; }
                const tripStartDate = new Date('2026-01-07'); const targetDayDate = new Date(tripStartDate); targetDayDate.setDate(tripStartDate.getDate() + activeDayIndex.value);
                if (Math.ceil((targetDayDate - new Date()) / 86400000) > 14) { weatherState.value = { status: 'too_early', data: null }; return; }
                weatherState.value = { status: 'loading', data: null };
                const dateStr = targetDayDate.toISOString().split('T')[0];
                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${day.lat}&longitude=${day.lon}&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Asia%2FTokyo&start_date=${dateStr}&end_date=${dateStr}`);
                    const data = await res.json();
                    if (data.daily) weatherState.value = { status: 'available', data: { max: Math.round(data.daily.temperature_2m_max[0]), min: Math.round(data.daily.temperature_2m_min[0]), code: data.daily.weathercode[0] } };
                } catch { weatherState.value = { status: 'too_early', data: null }; }
            };
            watch(activeDayIndex, fetchRealTimeWeather, { immediate: true });

            onMounted(() => { 
                lucide.createIcons(); 
                fetchExchangeRate();
                if (myFirebaseConfig.apiKey) initFirebase();
            });
            
            watch([currentView, activeDayIndex, expenses.value, isEditingTip, editingEventId], () => nextTick(() => lucide.createIcons()));

            return {
                currentView, activeDayIndex, itinerary, currentDayData, switchDay, getDayIcon, getWeatherIcon,
                expenses, newExpense, addExpense, deleteExpense, startEditExpense, saveEditExpense, cancelEditExpense, editingExpenseId, tempExpense,
                totalRealJPY, totalRealTWD, grandTotalInTWD, exchangeRate, members, daysRemaining,
                isEditingTip, tempTip, startEditTip, saveTip, parsedTips,
                toggleSplitter, toggleAllSplitters, showSettlement: calculateSettlement, showSettlementModal, settlementStats, transfersJPY, transfersTWD,
                weatherState, dbConnected, addNewDay, removeLastDay,
                fetchExchangeRate, isRateLoading,
                editingEventId, tempEvent, startEditEvent, saveEditEvent, cancelEditEvent, addNewEvent, deleteEvent,
                isEditingTitle, tempTitle, startEditTitle, saveTitle
            };
        }
    }).mount('#app');
</script>
</body>

</html>

