<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>名古屋親子旅帳 | Nagoya Trip</title>
    
    <!-- Vue 3 (Global) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, query, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        window.firebaseModules = { 
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, 
            getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, query, setDoc, getDoc 
        };
    </script>

    <style>
        body {
            font-family: 'Noto Sans TC', 'Noto Sans JP', sans-serif;
            background-color: #FDFCF8; /* 和紙白 */
            color: #433D3C; /* 墨黑 */
            overflow: hidden; /* 防止整個頁面捲動，只捲動內容區 */
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .bg-sidebar { background-color: #F4F1EA; } 
        .bg-active { background-color: #4B9CD3; color: white; }
        .text-accent { color: #2C5282; } 
        .bg-card { background-color: #FFFFFF; }
        .border-soft { border-color: #EDE9E0; }
        .prose-tips p { margin-bottom: 0.5em; line-height: 1.6; }
        .prose-tips ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 0.5em; }
        .prose-tips strong { color: #4B9CD3; font-weight: 700; }
        .prose-tips li { margin-bottom: 0.3em; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }
    </style>
</head>
<body>

<div id="app" class="flex h-[100dvh] w-full max-w-md mx-auto shadow-2xl relative overflow-hidden bg-[#FDFCF8]">

    <!-- 左側導航欄 -->
    <nav class="w-[80px] bg-sidebar flex flex-col items-center py-6 border-r border-soft h-full overflow-y-auto no-scrollbar z-20 flex-shrink-0">
        <!-- 倒數計時 -->
        <div class="mb-4 flex flex-col items-center justify-center w-14 h-14 rounded-full bg-[#433D3C] text-white shadow-lg relative overflow-hidden group cursor-default">
            <div class="absolute inset-0 bg-white/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
            <span class="text-[8px] opacity-70 mb-0.5">距離出發</span>
            <div class="flex items-baseline"><span class="text-sm font-bold font-mono leading-none">{{ daysRemaining }}</span><span class="text-[8px] ml-[1px]">天</span></div>
        </div>

        <div class="w-full px-2 mb-4 border-b border-gray-200 pb-4 flex flex-col items-center">
            <button @click="currentView = 'expense'" 
                class="flex flex-col items-center justify-center w-14 py-3 rounded-xl transition-all shadow-sm"
                :class="currentView === 'expense' ? 'bg-[#4B9CD3] text-white shadow-md scale-105' : 'bg-white border border-gray-100 text-gray-600 hover:bg-gray-50'">
                <i data-lucide="wallet" class="w-6 h-6 mb-1"></i>
                <span class="text-[10px] font-bold">記帳</span>
            </button>
        </div>

        <div class="flex-1 w-full space-y-3 flex flex-col items-center overflow-y-auto no-scrollbar pb-4">
            <!-- 天數按鈕 -->
            <button v-for="(day, index) in itinerary" :key="index" @click="switchDay(index)" class="flex flex-col items-center justify-center w-12 py-2 rounded-xl transition-all duration-300" :class="currentView === 'itinerary' && activeDayIndex === index ? 'bg-active shadow-md transform scale-105' : 'text-gray-400 hover:bg-white/50'">
                <i :data-lucide="getDayIcon(index)" class="w-5 h-5 mb-1"></i>
                <span class="text-[10px] font-bold">Day {{ index + 1 }}</span>
                <span class="text-[8px] font-mono opacity-80">{{ day.shortDate }}</span>
            </button>

            <!-- 控制區 -->
            <div class="flex flex-col gap-2 mt-2 border-t border-gray-200 pt-2 w-full items-center">
                
                <!-- 切換到「排序模式」按鈕 -->
                <button @click="currentView = 'reorder'" 
                    class="flex items-center justify-center w-8 h-8 rounded-full border-2 border-dashed border-gray-300 text-gray-400 hover:border-gray-500 hover:text-gray-600 transition-all" 
                    :class="currentView === 'reorder' ? 'bg-[#4B9CD3] text-white border-none shadow-md' : ''"
                    title="調整行程順序">
                    <i data-lucide="arrow-up-down" class="w-4 h-4"></i>
                </button>

                <!-- 側邊欄的新增/刪除保留，方便快速操作 -->
                <button @click="insertDay()" class="flex items-center justify-center w-8 h-8 rounded-full border-2 border-dashed border-gray-300 text-gray-400 hover:border-[#4B9CD3] hover:text-[#4B9CD3] hover:bg-white transition-all" title="插入一天"><i data-lucide="plus" class="w-4 h-4"></i></button>
                <button v-if="itinerary.length > 1" @click="removeDay(activeDayIndex)" class="flex items-center justify-center w-8 h-8 rounded-full border-2 border-dashed border-gray-300 text-gray-400 hover:border-red-400 hover:text-red-400 hover:bg-white transition-all" title="刪除此日"><i data-lucide="minus" class="w-4 h-4"></i></button>
            </div>
        </div>

        <div class="mt-auto w-full flex flex-col items-center space-y-3 border-t border-gray-200 pt-4 pb-safe bg-sidebar z-30">
            <button @click="currentView = 'settings'" class="flex flex-col items-center justify-center w-12 py-2 rounded-xl transition-all" :class="currentView === 'settings' ? 'bg-gray-200 text-gray-600' : 'text-gray-400'"><i data-lucide="settings" class="w-5 h-5 mb-1"></i><span class="text-[9px]">設定</span></button>
            <button @click="currentView = 'emergency'" class="flex flex-col items-center justify-center w-12 py-2 rounded-xl transition-all" :class="currentView === 'emergency' ? 'bg-red-50 text-red-500 border border-red-100' : 'text-gray-400'"><i data-lucide="siren" class="w-5 h-5 mb-1"></i><span class="text-[9px]">求助</span></button>
        </div>
    </nav>

    <!-- 右側主要內容區 -->
    <main class="flex-1 h-full overflow-y-auto no-scrollbar bg-[#FDFCF8] relative">
        
        <!-- VIEW: 行程表 -->
        <div v-if="currentView === 'itinerary'" class="min-h-full pb-safe">
            <div class="px-6 pt-8 pb-4">
                <div class="flex justify-between items-center mb-3">
                    <!-- 1. 日期編輯功能 -->
                    <div v-if="!isEditingDate" @click="startEditDate" class="inline-block bg-[#4B9CD3] text-white text-[10px] font-bold px-3 py-1 rounded-full tracking-wider shadow-sm cursor-pointer hover:bg-blue-600 transition-colors">
                        DAY {{ activeDayIndex + 1 }} • {{ currentDayData.date }} <i data-lucide="edit-3" class="w-3 h-3 inline ml-1 opacity-70"></i>
                    </div>
                    <div v-else class="flex items-center gap-2 animate-in fade-in">
                        <input v-model="tempDateString" class="text-[10px] px-2 py-1 rounded border border-blue-300 w-32 focus:outline-none focus:ring-1 focus:ring-blue-500" placeholder="例如: 1/8">
                        <button @click="saveDate" class="bg-blue-500 text-white p-1 rounded-full"><i data-lucide="check" class="w-3 h-3"></i></button>
                    </div>

                    <span v-if="dbConnected" class="text-[9px] text-green-600 bg-green-50 px-2 py-1 rounded-full flex items-center gap-1"><i data-lucide="cloud" class="w-3 h-3"></i> 已同步</span>
                </div>
                
                <div v-if="!isEditingTitle">
                    <h1 class="text-2xl font-bold text-[#433D3C] leading-tight mb-2" @click="startEditTitle">{{ currentDayData.title }}</h1>
                    <p class="text-xs text-gray-500 leading-relaxed mb-4" @click="startEditTitle">{{ currentDayData.desc }}</p>
                </div>
                <div v-else class="mb-4 space-y-2 animate-in fade-in">
                    <input v-model="tempTitle.title" class="w-full text-xl font-bold bg-gray-50 border rounded px-2 py-1">
                    <textarea v-model="tempTitle.desc" class="w-full text-xs bg-gray-50 border rounded px-2 py-1" rows="2"></textarea>
                    <div class="flex gap-2"><button @click="isEditingTitle = false" class="text-xs bg-gray-100 px-3 py-1 rounded">取消</button><button @click="saveTitle" class="text-xs bg-[#4B9CD3] text-white px-3 py-1 rounded font-bold">儲存</button></div>
                </div>

                <div class="flex flex-wrap gap-2 mb-4">
                    <span v-for="tag in currentDayData.tags" :key="tag" class="flex items-center gap-1 bg-blue-50 text-[#2C5282] px-2 py-1 rounded-lg text-[10px] font-bold border border-[#4B9CD3]/30"><i data-lucide="thumbs-up" class="w-3 h-3"></i> {{ tag }}</span>
                </div>

                <div class="bg-[#433D3C] text-white p-4 rounded-2xl shadow-lg mb-6 relative overflow-hidden group min-h-[100px] transition-all duration-300">
                    <div class="absolute top-0 right-0 w-16 h-16 bg-white/10 rounded-bl-full pointer-events-none"></div>
                    <div class="flex justify-between items-start relative z-10 mb-2">
                        <div class="flex items-center gap-2"><i data-lucide="lightbulb" class="w-4 h-4 text-[#4B9CD3]"></i><h4 class="text-xs font-bold text-[#4B9CD3]">行程重點提醒</h4></div>
                        <button v-if="!isEditingTip" @click="startEditTip" class="p-1 text-white/30 hover:text-white/90 hover:bg-white/10 rounded-full transition-all"><i data-lucide="pencil" class="w-3 h-3"></i></button>
                    </div>
                    <div class="relative z-10 pl-6 border-l-2 border-[#4B9CD3]/30 ml-2">
                        <div v-if="!isEditingTip" class="text-xs opacity-90 leading-relaxed prose-tips" v-html="parsedTips"></div>
                        <div v-else class="animate-in fade-in duration-200">
                            <textarea v-model="tempTip" rows="5" class="w-full bg-black/20 text-white text-xs p-2 rounded-lg border border-white/20 focus:border-[#4B9CD3] outline-none mb-2 leading-relaxed" placeholder="寫點什麼提醒自己吧..."></textarea>
                            <div class="flex gap-2 justify-end"><button @click="isEditingTip = false" class="px-3 py-1 text-[10px] text-gray-400 hover:text-white">取消</button><button @click="saveTip" class="px-3 py-1 bg-[#4B9CD3] text-[#433D3C] text-[10px] font-bold rounded-full hover:bg-white transition-colors">儲存</button></div>
                        </div>
                    </div>
                </div>

                <!-- 4. 天氣卡片 (可編輯地點與座標) -->
                <div class="bg-white border border-gray-100 p-4 rounded-2xl shadow-sm mb-2 relative overflow-hidden transition-all duration-300">
                    <div class="flex justify-between items-start mb-3 relative z-10">
                        <!-- 一般顯示模式 -->
                        <div v-if="!isEditingLocation" class="flex flex-col">
                            <span class="text-xs font-bold text-gray-600 flex items-center gap-1">
                                <i data-lucide="map-pin" class="w-3 h-3"></i> {{ currentDayData.location }}
                            </span>
                            <span class="text-[8px] text-gray-300 font-mono ml-4">{{ currentDayData.lat }}, {{ currentDayData.lon }}</span>
                        </div>
                        <!-- 編輯模式 -->
                        <div v-else class="flex flex-col gap-2 w-full pr-8 animate-in fade-in">
                            <input v-model="tempLocation.name" class="text-xs border rounded px-2 py-1 bg-gray-50" placeholder="地點名稱">
                            <div class="flex gap-2">
                                <input v-model="tempLocation.lat" class="text-[10px] border rounded px-2 py-1 w-1/2 bg-gray-50" placeholder="緯度 Lat">
                                <input v-model="tempLocation.lon" class="text-[10px] border rounded px-2 py-1 w-1/2 bg-gray-50" placeholder="經度 Lon">
                            </div>
                            <div class="flex gap-2 justify-end">
                                <a :href="`https://www.google.com/maps/search/?api=1&query=${tempLocation.name}`" target="_blank" class="text-[9px] text-blue-400 underline mr-auto self-center">查座標</a>
                                <button @click="isEditingLocation = false" class="text-[10px] px-2 py-1 bg-gray-100 rounded">取消</button>
                                <button @click="saveLocation" class="text-[10px] px-2 py-1 bg-[#4B9CD3] text-white rounded font-bold">更新天氣</button>
                            </div>
                        </div>

                        <!-- 按鈕區 -->
                        <button v-if="!isEditingLocation" @click="startEditLocation" class="text-gray-300 hover:text-blue-500 absolute top-0 right-0 p-1">
                            <i data-lucide="edit-3" class="w-3 h-3"></i>
                        </button>
                        
                        <span v-if="!isEditingLocation && weatherState.status === 'loading'" class="text-[9px] bg-gray-100 text-gray-400 px-2 py-1 rounded-full flex items-center gap-1 self-start"><i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i> 讀取中</span>
                        <span v-else-if="!isEditingLocation && weatherState.status === 'too_early'" class="text-[9px] bg-gray-100 text-gray-400 px-2 py-1 rounded-full self-start">尚無預報資料</span>
                        <span v-else-if="!isEditingLocation" class="text-[9px] bg-green-50 text-green-600 px-2 py-1 rounded-full border border-green-100 flex items-center gap-1 self-start"><i data-lucide="check-circle" class="w-3 h-3"></i> 氣象預報</span>
                    </div>

                    <div v-if="weatherState.status === 'available'" class="flex justify-between items-center text-center relative z-10 animate-in fade-in">
                        <div class="flex flex-col items-center"><span class="text-[10px] text-gray-400">最低</span><i data-lucide="thermometer" class="w-5 h-5 text-blue-300 my-1"></i><span class="text-xs font-bold">{{ weatherState.data.min }}°</span></div>
                        <div class="w-[1px] h-6 bg-gray-100"></div>
                        <div class="flex flex-col items-center"><span class="text-[10px] text-gray-400">天氣</span><i :data-lucide="getWeatherIcon(weatherState.data.code)" class="w-6 h-6 text-[#4B9CD3] my-1"></i><span class="text-xs font-bold">{{ weatherState.data.max }}° / {{ weatherState.data.min }}°</span></div>
                        <div class="w-[1px] h-6 bg-gray-100"></div>
                        <div class="flex flex-col items-center"><span class="text-[10px] text-gray-400">最高</span><i data-lucide="sun" class="w-5 h-5 text-orange-300 my-1"></i><span class="text-xs font-bold">{{ weatherState.data.max }}°</span></div>
                    </div>
                </div>
            </div>

            <div class="px-4 pb-20">
                <div class="relative pl-4 border-l-2 border-dashed border-gray-200 ml-2 space-y-6">
                    <div v-for="(event, eIdx) in currentDayData.events" :key="event.id" class="relative pl-6 group">
                        <div class="absolute -left-[9px] top-0 w-4 h-4 rounded-full border-2 border-[#FDFCF8] shadow-sm flex items-center justify-center bg-[#4B9CD3]"></div>
                        
                        <div v-if="editingEventId !== event.id">
                            <div class="text-xs font-mono font-bold text-[#4B9CD3] mb-1">{{ event.time }}</div>
                            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 hover:shadow-md transition-shadow relative">
                                <h3 class="font-bold text-gray-800 text-sm mb-1">{{ event.title }}</h3>
                                <p class="text-xs text-gray-500 mb-3">{{ event.sub }}</p>
                                <div class="flex gap-2 flex-wrap">
                                    <a v-if="event.mapUrl" :href="event.mapUrl" target="_blank" class="flex items-center gap-1 px-3 py-1.5 rounded-full bg-gray-800 text-white text-[10px] font-medium active:scale-95 transition-transform"><i data-lucide="navigation" class="w-3 h-3"></i> 導航</a>
                                    <a v-else :href="`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(event.title + ' ' + event.sub)}`" target="_blank" class="flex items-center gap-1 px-3 py-1.5 rounded-full bg-gray-800 text-white text-[10px] font-medium active:scale-95 transition-transform"><i data-lucide="navigation" class="w-3 h-3"></i> 導航</a>
                                    <a v-if="event.link" :href="event.link" target="_blank" class="flex items-center gap-1 px-3 py-1.5 rounded-full border border-gray-200 text-gray-600 text-[10px] font-medium hover:bg-gray-50"><i data-lucide="external-link" class="w-3 h-3"></i> 官網</a>
                                    <button v-if="event.ticket" @click="openTicketViewer(event)" class="flex items-center gap-1 px-3 py-1.5 rounded-full bg-[#4B9CD3] text-white text-[10px] font-medium shadow-sm hover:bg-[#3A8CC3] active:scale-95 transition-all">
                                        <i data-lucide="ticket" class="w-3 h-3"></i> 查看憑證
                                    </button>
                                </div>
                                <div class="absolute top-2 right-2 flex gap-1">
                                    <button @click="startEditEvent(event)" class="text-gray-300 hover:text-blue-400 p-1"><i data-lucide="pencil" class="w-3.5 h-3.5"></i></button>
                                    <button @click="deleteEvent(eIdx)" class="text-gray-300 hover:text-red-400 p-1"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                                </div>
                            </div>
                        </div>

                        <!-- 2. 行程編輯：時間選單與自動排序 -->
                        <div v-else class="bg-white rounded-xl p-3 shadow-md border border-[#4B9CD3] animate-in fade-in">
                            <div class="space-y-2">
                                <div class="flex gap-2">
                                    <!-- 時間改為選單 -->
                                    <select v-model="tempEvent.time" class="w-1/3 bg-gray-50 border rounded px-2 py-1 text-xs font-mono">
                                        <option v-for="t in timeOptions" :key="t" :value="t">{{ t }}</option>
                                    </select>
                                    <input v-model="tempEvent.title" class="w-2/3 bg-gray-50 border rounded px-2 py-1 text-xs font-bold" placeholder="標題">
                                </div>
                                <input v-model="tempEvent.sub" class="w-full bg-gray-50 border rounded px-2 py-1 text-xs" placeholder="地點/描述">
                                <input v-model="tempEvent.mapUrl" class="w-full bg-gray-50 border rounded px-2 py-1 text-[10px]" placeholder="Google Maps 連結 (選填)">
                                <input v-model="tempEvent.link" class="w-full bg-gray-50 border rounded px-2 py-1 text-[10px]" placeholder="官方網站連結 (選填)">
                                
                                <div class="border-t border-gray-100 pt-2 mt-1">
                                    <label class="block text-[10px] font-bold text-gray-500 mb-1 flex items-center gap-1"><i data-lucide="image" class="w-3 h-3"></i> 上傳憑證 (圖片)</label>
                                    <input type="file" accept="image/*" @change="handleTicketUpload" class="w-full text-[10px] text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-[10px] file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                    <div v-if="tempEvent.ticket || tempTicketFile" class="flex items-center gap-1 mt-1">
                                        <span class="text-[10px] text-green-600 bg-green-50 px-2 py-0.5 rounded flex items-center gap-1"><i data-lucide="check" class="w-3 h-3"></i> {{ tempTicketFile ? '準備上傳' : '已有憑證' }}</span>
                                        <button v-if="tempEvent.ticket && !tempTicketFile" @click="deleteTicketInEdit(eIdx)" class="text-[9px] text-red-400 underline ml-2">刪除現有憑證</button>
                                    </div>
                                </div>

                                <div class="flex gap-2 pt-1">
                                    <button @click="cancelEditEvent" class="flex-1 py-1.5 bg-gray-100 text-gray-500 rounded text-xs">取消</button>
                                    <button @click="saveEditEvent(eIdx)" class="flex-1 py-1.5 bg-[#4B9CD3] text-white rounded text-xs font-bold flex items-center justify-center gap-1">
                                        <i v-if="isUploading" data-lucide="loader-2" class="w-3 h-3 animate-spin"></i>
                                        {{ isUploading ? '上傳中...' : '完成' }}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button @click="addNewEvent" class="ml-6 w-[calc(100%-1.5rem)] py-3 border border-dashed border-gray-300 rounded-xl text-gray-400 text-xs hover:border-[#4B9CD3] hover:text-[#4B9CD3] transition-colors flex items-center justify-center gap-2"><i data-lucide="plus" class="w-3 h-3"></i> 新增行程</button>
                </div>
            </div>
        </div>

        <!-- NEW VIEW: 行程排序 (視覺化列表) -->
        <div v-if="currentView === 'reorder'" class="h-full bg-[#FDFCF8] p-6 overflow-y-auto pb-safe">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <i data-lucide="arrow-up-down" class="w-6 h-6 text-[#4B9CD3]"></i> 調整行程順序
                </h2>
                <button @click="currentView = 'itinerary'" class="text-sm font-bold text-[#4B9CD3] bg-blue-50 px-3 py-1.5 rounded-full hover:bg-blue-100 transition-colors">
                    <i data-lucide="check" class="w-4 h-4 inline mr-1"></i>完成
                </button>
            </div>
            
            <p class="text-xs text-gray-400 mb-4 bg-gray-50 p-2 rounded-lg border border-gray-100">
                <i data-lucide="info" class="w-3 h-3 inline mr-1"></i> 上下移動卡片以交換行程，或使用垃圾桶刪除。
            </p>

            <div class="space-y-3 pb-20">
                <div v-for="(day, index) in itinerary" :key="index" class="flex items-center gap-3 bg-white p-3 rounded-xl border border-gray-100 shadow-sm relative overflow-hidden transition-all hover:shadow-md">
                    <!-- 左側：固定日期顯示 -->
                    <div class="flex flex-col items-center justify-center w-14 flex-shrink-0 bg-gray-50 rounded-lg py-2 h-full">
                        <span class="text-[10px] font-bold text-[#4B9CD3] uppercase tracking-wider">DAY</span>
                        <span class="text-xl font-bold text-gray-700 leading-none my-0.5">{{ index + 1 }}</span>
                        <span class="text-[9px] text-gray-400 font-mono">{{ day.shortDate }}</span>
                    </div>
                    
                    <!-- 中間：行程內容 (會被移動的部分) -->
                    <div class="flex-1 min-w-0 border-l border-gray-100 pl-3">
                        <div class="flex items-center gap-2 mb-1">
                            <h3 class="text-sm font-bold text-gray-800 truncate">{{ day.title }}</h3>
                        </div>
                        <p class="text-[10px] text-gray-500 truncate flex items-center gap-1">
                            <i data-lucide="map-pin" class="w-3 h-3"></i> {{ day.location }}
                        </p>
                        <div class="flex gap-1 mt-1.5 overflow-x-auto no-scrollbar">
                            <span v-for="tag in day.tags" :key="tag" class="text-[8px] bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded whitespace-nowrap">{{ tag }}</span>
                        </div>
                    </div>

                    <!-- 右側：移動/刪除按鈕 -->
                    <div class="flex flex-col gap-1 pl-1 border-l border-dashed border-gray-200">
                        <div class="flex flex-col gap-1">
                            <button @click="moveDay(index, -1)" :disabled="index === 0" class="p-1.5 rounded-lg hover:bg-blue-50 text-gray-400 hover:text-[#4B9CD3] disabled:opacity-20 disabled:hover:bg-transparent disabled:cursor-not-allowed transition-colors">
                                <i data-lucide="chevron-up" class="w-4 h-4"></i>
                            </button>
                            <button @click="moveDay(index, 1)" :disabled="index === itinerary.length - 1" class="p-1.5 rounded-lg hover:bg-blue-50 text-gray-400 hover:text-[#4B9CD3] disabled:opacity-20 disabled:hover:bg-transparent disabled:cursor-not-allowed transition-colors">
                                <i data-lucide="chevron-down" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <button @click="removeDay(index)" class="mt-1 p-1.5 rounded-lg hover:bg-red-50 text-red-300 hover:text-red-500 transition-colors" title="刪除此日">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
                
                <!-- 底部新增按鈕 -->
                <button @click="insertDay(itinerary.length - 1)" class="w-full py-4 border-2 border-dashed border-[#4B9CD3]/50 rounded-xl text-[#4B9CD3] font-bold flex items-center justify-center gap-2 hover:bg-[#4B9CD3]/10 transition-colors">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i> 新增一天
                </button>
            </div>
        </div>
        
        <!-- 3. VIEW: 緊急求助 (全新設計) -->
        <div v-if="currentView === 'emergency'" class="h-full bg-[#2D2A29] p-6 overflow-y-auto pb-safe text-white">
            <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-red-500/20 flex items-center justify-center"><i data-lucide="siren" class="w-6 h-6 text-red-500"></i></div>
                緊急求助
            </h2>

            <div class="space-y-4">
                <!-- 警察 -->
                <div class="bg-[#3E3A39] p-5 rounded-2xl flex items-center justify-between border border-white/5 shadow-lg">
                    <div>
                        <h3 class="text-xl font-bold text-red-400">警察局</h3>
                        <p class="text-xs text-gray-400 mt-1">犯罪、事故、遺失物品</p>
                    </div>
                    <a href="tel:110" class="flex items-center gap-2 bg-red-500 hover:bg-red-600 text-white px-5 py-3 rounded-xl font-bold transition-all active:scale-95">
                        <i data-lucide="phone" class="w-5 h-5"></i> 110
                    </a>
                </div>

                <!-- 消防/救護 -->
                <div class="bg-[#3E3A39] p-5 rounded-2xl flex items-center justify-between border border-white/5 shadow-lg">
                    <div>
                        <h3 class="text-xl font-bold text-orange-400">救護車 / 消防</h3>
                        <p class="text-xs text-gray-400 mt-1">受傷、急病、火災</p>
                    </div>
                    <a href="tel:119" class="flex items-center gap-2 bg-orange-500 hover:bg-orange-600 text-white px-5 py-3 rounded-xl font-bold transition-all active:scale-95">
                        <i data-lucide="phone" class="w-5 h-5"></i> 119
                    </a>
                </div>

                <!-- 台灣辦事處 (可編輯) -->
                <div class="bg-[#3E3A39] p-5 rounded-2xl border border-blue-500/30 shadow-lg relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-2 opacity-50 hover:opacity-100 cursor-pointer" @click="isEditingOffice = !isEditingOffice">
                        <i data-lucide="settings-2" class="w-4 h-4 text-gray-400"></i>
                    </div>
                    
                    <div v-if="!isEditingOffice">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-lg font-bold text-blue-400">{{ officeInfo.name }}</h3>
                        </div>
                        <p class="text-xs text-gray-300 leading-relaxed mb-4">{{ officeInfo.desc }}</p>
                        <a :href="`tel:${officeInfo.phone}`" class="w-full flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold transition-all active:scale-95">
                            <i data-lucide="phone" class="w-4 h-4"></i> 撥打 {{ officeInfo.phone }}
                        </a>
                    </div>
                    <div v-else class="space-y-3 animate-in fade-in">
                        <input v-model="officeInfo.name" class="w-full bg-black/30 border border-white/10 rounded px-3 py-2 text-sm text-white" placeholder="辦事處名稱">
                        <input v-model="officeInfo.phone" class="w-full bg-black/30 border border-white/10 rounded px-3 py-2 text-sm text-white font-mono" placeholder="電話號碼">
                        <textarea v-model="officeInfo.desc" class="w-full bg-black/30 border border-white/10 rounded px-3 py-2 text-xs text-white" rows="2" placeholder="備註 (如: 護照遺失...)"></textarea>
                        <button @click="saveOfficeInfo" class="w-full bg-blue-600 text-white py-2 rounded-lg text-sm font-bold">儲存</button>
                    </div>
                </div>

                <!-- 緊急聯絡人 (可編輯) -->
                <div class="bg-[#3E3A39] p-5 rounded-2xl border border-yellow-500/30 shadow-lg mt-6">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-sm font-bold text-yellow-500 flex items-center gap-2"><i data-lucide="alert-triangle" class="w-4 h-4"></i> 緊急聯絡手機</h4>
                        <button @click="isEditingContact = !isEditingContact" class="text-xs text-gray-500 hover:text-white underline">編輯</button>
                    </div>
                    
                    <div v-if="!isEditingContact" class="text-center">
                        <div class="text-2xl font-mono font-bold text-white mb-2">{{ emergencyContact }}</div>
                        <a :href="`tel:${emergencyContact}`" class="inline-flex items-center gap-1 text-xs bg-white/10 px-3 py-1 rounded-full text-gray-300 hover:bg-white/20">
                            <i data-lucide="phone-call" class="w-3 h-3"></i> 點擊撥打
                        </a>
                    </div>
                    <div v-else class="flex gap-2">
                        <input v-model="emergencyContact" class="flex-1 bg-black/30 border border-white/10 rounded px-3 py-2 text-sm text-white font-mono" placeholder="輸入號碼">
                        <button @click="saveEmergencyContact" class="bg-yellow-600 text-white px-4 rounded-lg font-bold text-sm">儲存</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: 記帳助手 (保持不變) -->
        <div v-if="currentView === 'expense'" class="h-full bg-[#FDFCF8] p-6 overflow-y-auto pb-safe">
            <div class="flex justify-between items-center mb-1">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2"><i data-lucide="wallet" class="w-6 h-6 text-[#4B9CD3]"></i> 記帳助手</h2>
                <div class="flex gap-2">
                    <span v-if="!dbConnected" class="text-[10px] text-gray-400 bg-gray-100 px-2 py-1 rounded-full flex items-center gap-1" title="請設定 Firebase 以啟用雲端功能"><i data-lucide="hard-drive" class="w-3 h-3"></i> 本機</span>
                    <span v-else class="text-[10px] text-green-600 bg-green-50 px-2 py-1 rounded-full flex items-center gap-1"><i data-lucide="cloud" class="w-3 h-3"></i> 同步中</span>
                    <button @click="showSettlement" class="bg-gray-800 text-white text-[10px] px-3 py-1.5 rounded-full font-bold flex items-center gap-1 shadow-md active:scale-95 transition-transform">
                        <i data-lucide="calculator" class="w-3 h-3"></i> 結算
                    </button>
                </div>
            </div>
            <div class="flex items-center gap-1 mb-6">
                <p class="text-xs text-gray-400 font-mono">1 JPY ≈ {{ exchangeRate }} TWD</p>
                <span v-if="isRateLoading" class="text-[10px] text-gray-300 animate-pulse">(更新中...)</span>
            </div>

            <!-- 總花費 -->
            <div class="bg-[#4B9CD3] rounded-3xl p-6 text-center shadow-lg shadow-blue-100 mb-8 relative overflow-hidden text-white">
                <div class="absolute -right-6 -top-6 w-24 h-24 bg-white opacity-20 rounded-full"></div>
                <div class="absolute -left-6 -bottom-6 w-20 h-20 bg-white opacity-20 rounded-full"></div>
                <div class="grid grid-cols-2 gap-4 relative z-10">
                    <div class="text-center border-r border-white/20"><p class="text-[10px] font-bold text-blue-100 uppercase tracking-widest mb-1 opacity-80">日幣支出</p><h3 class="text-xl font-bold tracking-tight font-mono">¥{{ totalRealJPY.toLocaleString() }}</h3></div>
                    <div class="text-center"><p class="text-[10px] font-bold text-blue-100 uppercase tracking-widest mb-1 opacity-80">台幣支出</p><h3 class="text-xl font-bold tracking-tight font-mono">NT${{ totalRealTWD.toLocaleString() }}</h3></div>
                </div>
                <div class="mt-4 pt-4 border-t border-white/20 relative z-10"><div class="inline-block bg-black/10 px-3 py-1 rounded-full text-white/90 text-xs font-mono">總計折合約 NT$ {{ grandTotalInTWD.toLocaleString() }}</div></div>
            </div>

            <!-- 輸入區塊 -->
            <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm space-y-4">
                <input v-model="newExpense.title" placeholder="品項 (如: 鰻魚飯)" class="w-full bg-gray-50 border-none rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-[#4B9CD3] outline-none">
                <div class="flex gap-2">
                    <div class="flex bg-gray-100 rounded-xl p-1 flex-shrink-0">
                        <button @click="newExpense.currency = 'JPY'" class="px-3 py-2 rounded-lg text-xs font-bold transition-all" :class="newExpense.currency === 'JPY' ? 'bg-white text-[#4B9CD3] shadow-sm' : 'text-gray-400'">¥</button>
                        <button @click="newExpense.currency = 'TWD'" class="px-3 py-2 rounded-lg text-xs font-bold transition-all" :class="newExpense.currency === 'TWD' ? 'bg-white text-[#4B9CD3] shadow-sm' : 'text-gray-400'">NT$</button>
                    </div>
                    <input v-model="newExpense.amount" type="number" placeholder="金額" class="flex-1 bg-gray-50 border-none rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-[#4B9CD3] outline-none font-mono">
                </div>
                <div class="bg-gray-50 rounded-xl p-3 space-y-3">
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-bold text-gray-500 w-16">誰先付錢</span>
                        <select v-model="newExpense.payer" class="bg-white border border-gray-200 rounded-lg px-3 py-1.5 text-xs text-gray-700 outline-none flex-1"><option v-for="member in members" :key="member" :value="member">{{ member }}</option><option value="公費">公費支出</option></select>
                    </div>
                    <div class="flex items-start gap-2">
                        <span class="text-xs font-bold text-gray-500 w-16 mt-1.5">分給誰</span>
                        <div class="flex-1 flex flex-wrap gap-2">
                            <button @click="toggleAllSplitters(newExpense)" class="px-2 py-1 rounded-md text-[10px] border transition-colors" :class="newExpense.splitters.length === members.length ? 'bg-[#4B9CD3] text-white border-[#4B9CD3]' : 'bg-white text-gray-400 border-gray-200'">全選</button>
                            <button v-for="member in members" :key="member" @click="toggleSplitter(newExpense, member)" class="px-2 py-1 rounded-md text-[10px] border transition-colors" :class="newExpense.splitters.includes(member) ? 'bg-gray-700 text-white border-gray-700' : 'bg-white text-gray-500 border-gray-200'">{{ member }}</button>
                        </div>
                    </div>
                </div>
                <button @click="addExpense" class="w-full bg-[#433D3C] text-[#4B9CD3] font-bold py-3 rounded-xl text-sm shadow-md hover:bg-black transition-colors">新增紀錄</button>
            </div>

            <!-- 列表 -->
            <div class="mt-6 space-y-3 pb-20">
                <h4 class="text-xs font-bold text-gray-400 pl-1">近期支出</h4>
                <div v-if="expenses.length === 0" class="text-center text-gray-300 text-xs py-4">目前沒有紀錄</div>
                <div v-for="ex in expenses" :key="ex.id" class="bg-white p-4 rounded-xl border border-gray-50 transition-all">
                    <div v-if="editingExpenseId !== ex.id" class="flex justify-between items-center group">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-xs text-gray-500 font-bold flex-shrink-0">{{ ex.payer[0] }}</div>
                            <div>
                                <div class="text-sm font-bold text-gray-800">{{ ex.title }}</div>
                                <div class="text-[10px] text-gray-400 flex flex-col"><span>{{ ex.date }} • {{ ex.payer }} 先付</span><span class="text-gray-300 text-[9px] mt-0.5" v-if="ex.splitters && ex.splitters.length < members.length">分給: {{ ex.splitters.join(', ') }}</span></div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="text-right"><div class="text-sm font-bold text-gray-800 font-mono">{{ ex.currency === 'JPY' ? '¥' : 'NT$' }} {{ Number(ex.amount).toLocaleString() }}</div></div>
                            <div class="flex flex-col gap-1"><button @click="startEditExpense(ex)" class="text-gray-300 hover:text-blue-500"><i data-lucide="edit-2" class="w-3.5 h-3.5"></i></button><button @click="deleteExpense(ex.id)" class="text-gray-300 hover:text-red-500"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button></div>
                        </div>
                    </div>
                    <!-- 支出編輯模式 -->
                    <div v-else class="space-y-3">
                        <div class="flex justify-between items-center mb-2"><span class="text-xs font-bold text-[#4B9CD3]">編輯支出</span></div>
                        <input v-model="tempExpense.title" class="w-full bg-gray-50 border-none rounded-lg px-3 py-2 text-xs" placeholder="品項">
                        <div class="flex gap-2"><div class="flex bg-gray-100 rounded-lg p-0.5"><button @click="tempExpense.currency = 'JPY'" class="px-2 py-1.5 rounded-md text-[10px] font-bold" :class="tempExpense.currency === 'JPY' ? 'bg-white text-[#4B9CD3]' : 'text-gray-400'">¥</button><button @click="tempExpense.currency = 'TWD'" class="px-2 py-1.5 rounded-md text-[10px] font-bold" :class="tempExpense.currency === 'TWD' ? 'bg-white text-[#4B9CD3]' : 'text-gray-400'">NT$</button></div><input v-model="tempExpense.amount" class="flex-1 bg-gray-50 border-none rounded-lg px-3 py-2 text-xs font-mono"></div>
                        <div class="flex gap-2">
                            <select v-model="tempExpense.payer" class="bg-gray-50 rounded-lg px-3 py-2 text-xs text-gray-600 outline-none flex-1"><option v-for="member in members" :key="member" :value="member">{{ member }}</option><option value="公費">公費支出</option></select>
                            <div class="flex gap-1"><button @click="cancelEditExpense" class="px-3 py-1.5 bg-gray-100 text-gray-500 rounded-lg text-xs font-bold">取消</button><button @click="saveEditExpense" class="px-3 py-1.5 bg-[#433D3C] text-[#4B9CD3] rounded-lg text-xs font-bold">儲存</button></div>
                        </div>
                        <div class="flex items-start gap-2 bg-gray-50 p-2 rounded-lg"><span class="text-[10px] font-bold text-gray-500 w-10 mt-1">分攤</span><div class="flex-1 flex flex-wrap gap-1"><button @click="toggleAllSplitters(tempExpense)" class="px-2 py-0.5 rounded text-[10px] border" :class="tempExpense.splitters.length === members.length ? 'bg-[#4B9CD3] text-white' : 'bg-white text-gray-400'">全</button><button v-for="m in members" :key="m" @click="toggleSplitter(tempExpense, m)" class="px-2 py-0.5 rounded text-[10px] border" :class="tempExpense.splitters.includes(m) ? 'bg-gray-700 text-white' : 'bg-white text-gray-500'">{{ m }}</button></div></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: 設定 (新增：成員管理功能) -->
        <div v-if="currentView === 'settings'" class="h-full bg-[#FDFCF8] p-6 overflow-y-auto">
            <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                <i data-lucide="settings" class="w-6 h-6 text-[#4B9CD3]"></i> 設定
            </h2>
            
            <div class="space-y-4">
                <!-- 1. 匯率設定 -->
                <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm">
                    <h3 class="text-sm font-bold text-gray-700 mb-2">匯率設定</h3>
                    <div class="flex items-center gap-3">
                        <span class="text-xs text-gray-500">1 JPY = </span>
                        <input type="number" v-model="exchangeRate" step="0.001" class="w-24 bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-xs text-center outline-none focus:border-[#4B9CD3]">
                        <span class="text-xs text-gray-500">TWD</span>
                    </div>
                    <button @click="fetchExchangeRate" class="mt-2 text-[10px] text-blue-500 underline flex items-center gap-1"><i data-lucide="refresh-cw" class="w-3 h-3" :class="{'animate-spin': isRateLoading}"></i> 抓取即時匯率</button>
                </div>

                <!-- 2. 成員名單設定 (新增) -->
                <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm">
                    <h3 class="text-sm font-bold text-gray-700 mb-3">成員名單 (記帳用)</h3>
                    <div class="flex flex-wrap gap-2 mb-4">
                        <div v-for="(member, idx) in members" :key="member" class="flex items-center gap-1 bg-gray-100 px-3 py-1.5 rounded-full text-xs text-gray-600">
                            {{ member }}
                            <button @click="removeMember(idx)" class="text-gray-400 hover:text-red-500 ml-1"><i data-lucide="x" class="w-3 h-3"></i></button>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <input v-model="newMemberName" @keyup.enter="addMember" placeholder="輸入成員名稱..." class="flex-1 bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-xs outline-none focus:border-[#4B9CD3]">
                        <button @click="addMember" class="bg-[#4B9CD3] text-white px-3 py-2 rounded-lg text-xs font-bold">新增</button>
                    </div>
                </div>
            </div>

            <p v-if="dbConnected" class="text-[10px] text-green-500 mt-6 flex items-center gap-1 justify-center"><i data-lucide="check" class="w-3 h-3"></i> Firebase 連線正常 (Nagoya 2026)</p>
        </div>

        <!-- Settlement Modal -->
        <div v-if="showSettlementModal" class="fixed inset-0 z-50 flex items-center justify-center p-4">
            <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" @click="showSettlementModal = false"></div>
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 relative z-10 animate-in fade-in zoom-in duration-200 max-h-[90vh] overflow-y-auto">
                <button @click="showSettlementModal = false" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button>
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2"><i data-lucide="calculator" class="w-5 h-5 text-[#4B9CD3]"></i> 雙幣結算報告</h3>
                <div class="space-y-4 mb-6">
                    <div v-for="stat in settlementStats" :key="stat.name" class="flex flex-col text-xs border-b border-gray-50 pb-2">
                        <div class="flex justify-between items-center mb-1"><span class="font-bold text-gray-800 text-sm">{{ stat.name }}</span></div>
                        <div class="flex justify-between"><span class="text-gray-400">日幣淨額</span><span class="font-mono font-bold" :class="stat.netJPY >= 0 ? 'text-green-500' : 'text-red-500'">{{ stat.netJPY >= 0 ? '收' : '付' }} ¥{{ Math.abs(stat.netJPY).toLocaleString() }}</span></div>
                        <div class="flex justify-between"><span class="text-gray-400">台幣淨額</span><span class="font-mono font-bold" :class="stat.netTWD >= 0 ? 'text-green-500' : 'text-red-500'">{{ stat.netTWD >= 0 ? '收' : '付' }} ${{ Math.abs(stat.netTWD).toLocaleString() }}</span></div>
                    </div>
                </div>
                <div class="bg-gray-50 rounded-2xl p-4 mb-3"><h4 class="text-xs font-bold text-gray-500 mb-3 uppercase tracking-wider flex items-center gap-1"><i data-lucide="coins" class="w-3 h-3"></i> 日幣轉帳建議</h4><div v-if="transfersJPY.length === 0" class="text-center text-gray-400 text-xs py-1">無日幣帳款</div><div v-else class="space-y-2"><div v-for="(transfer, idx) in transfersJPY" :key="idx" class="flex items-center justify-between bg-white p-2 rounded-lg border border-gray-100 shadow-sm"><div class="flex items-center gap-1"><span class="font-bold text-gray-800 text-xs">{{ transfer.from }}</span><span class="text-[9px] text-gray-400">給</span><i data-lucide="arrow-right" class="w-3 h-3 text-[#4B9CD3]"></i><span class="font-bold text-gray-800 text-xs">{{ transfer.to }}</span></div><span class="font-mono font-bold text-[#4B9CD3] text-xs">¥{{ transfer.amount.toLocaleString() }}</span></div></div></div>
                <div class="bg-gray-50 rounded-2xl p-4"><h4 class="text-xs font-bold text-gray-500 mb-3 uppercase tracking-wider flex items-center gap-1"><i data-lucide="banknote" class="w-3 h-3"></i> 台幣轉帳建議</h4><div v-if="transfersTWD.length === 0" class="text-center text-gray-400 text-xs py-1">無台幣帳款</div><div v-else class="space-y-2"><div v-for="(transfer, idx) in transfersTWD" :key="idx" class="flex items-center justify-between bg-white p-2 rounded-lg border border-gray-100 shadow-sm"><div class="flex items-center gap-1"><span class="font-bold text-gray-800 text-xs">{{ transfer.from }}</span><span class="text-[9px] text-gray-400">給</span><i data-lucide="arrow-right" class="w-3 h-3 text-[#4B9CD3]"></i><span class="font-bold text-gray-800 text-xs">{{ transfer.to }}</span></div><span class="font-mono font-bold text-[#4B9CD3] text-xs">${{ transfer.amount.toLocaleString() }}</span></div></div></div>
                <button @click="showSettlementModal = false" class="w-full mt-6 bg-[#433D3C] text-white py-3 rounded-xl font-bold text-sm">關閉</button>
            </div>
        </div>
        
        <!-- Ticket Viewer Modal (New) -->
        <div v-if="viewingTicket" class="fixed inset-0 z-50 flex items-center justify-center bg-black/90 p-4" @click="closeTicketViewer">
            <div class="relative max-w-full max-h-full" @click.stop>
                <img v-if="ticketImageUrl" :src="ticketImageUrl" class="max-w-full max-h-[85vh] rounded-lg shadow-2xl object-contain">
                <div v-else class="text-white text-center p-4"><i data-lucide="loader-2" class="w-8 h-8 animate-spin mx-auto mb-2"></i><p>讀取憑證中...</p></div>
                <button @click="closeTicketViewer" class="absolute -top-10 right-0 text-white p-2 hover:bg-white/20 rounded-full"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
        </div>

    </main>
</div>

<script type="module">
    const { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, query, setDoc, getDoc } = window.firebaseModules;
    const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

    createApp({
        setup() {
            const currentView = ref('itinerary');
            const activeDayIndex = ref(0);
            const exchangeRate = ref(0.22);
            const isRateLoading = ref(false);
            
            // 編輯相關
            const isEditingTip = ref(false);
            const tempTip = ref('');
            const editingEventId = ref(null);
            const tempEvent = ref({});
            const editingExpenseId = ref(null);
            const tempExpense = ref({});
            const isEditingTitle = ref(false);
            const tempTitle = ref({title: '', desc: ''});
            
            // 新增：日期編輯
            const isEditingDate = ref(false);
            const tempDateString = ref('');
            
            // 新增：地點/天氣編輯
            const isEditingLocation = ref(false);
            const tempLocation = ref({name: '', lat: 0, lon: 0});

            // 新增：求助資訊
            const isEditingOffice = ref(false);
            const officeInfo = ref({
                name: "台北駐大阪經濟文化辦事處", // 管轄名古屋
                phone: "+81-6-6227-8623",
                desc: "護照遺失、急難救助 (管轄愛知縣)"
            });
            const isEditingContact = ref(false);
            const emergencyContact = ref("+886-912-345-678");

            // 憑證上傳相關
            const tempTicketFile = ref(null);
            const isUploading = ref(false);
            const viewingTicket = ref(false);
            const ticketImageUrl = ref(null);

            // 記帳與設定
            const dbConnected = ref(false);
            const showSettlementModal = ref(false);
            const settlementStats = ref([]);
            const transfersJPY = ref([]);
            const transfersTWD = ref([]);
            const weatherState = ref({ status: 'loading', data: null });

            const members = ref(['品萱1', '品萱2', '品萱3', 'OY1', 'OY2', 'OY3', 'OY4', 'RUBY1', 'RUBY2']);
            const newMemberName = ref(''); // For adding new member
            const expenses = ref([]);
            const newExpense = ref({ title: '', amount: '', payer: 'OY', currency: 'JPY', splitters: [...members.value] });
            
            // 新增：時間選單 (00:00 - 23:45)
            const timeOptions = [];
            for(let h=0; h<24; h++) {
                for(let m=0; m<60; m+=15) {
                    timeOptions.push(`${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`);
                }
            }

            const myFirebaseConfig = {
                apiKey: "AIzaSyDPsTLpK7VaGgJoZk3_Kmqzjia-rOR5fNY",
                authDomain: "hokkaido-trip-f44e9.firebaseapp.com",
                projectId: "hokkaido-trip-f44e9",
                storageBucket: "hokkaido-trip-f44e9.firebasestorage.app",
                messagingSenderId: "592554790310",
                appId: "1:592554790310:web:b50f36effd908a872d9367",
                measurementId: "G-36BG8FB13C"
            };

            const defaultItinerary = [
                { 
                    date: "1/7 (三)", shortDate: "1/7", title: "抵達名古屋購物日", 
                    desc: "抵達中部國際機場，市區購物，入住溫馨民宿。", location: "名古屋", lat: 35.1815, lon: 136.9066, tags: ["寶可夢", "HARBS", "鰻魚飯"],
                    tips: "✈️ 07:35 - 11:03 抵達中部國際機場\n🚐 12:30 機場出發 (約40-50分)\n📍 住宿：Yonchōda-801-10 Shippōchō Akitake, Ama, Aichi 497-0003日本\n🍽️ 午餐：あつた蓬莱軒(鰻魚飯) 或 矢場味噌豬排",
                    events: [
                        { id: 1, time: "07:35", title: "抵達機場", sub: "11:03 降落 NGO", link: "", ticket: false },
                        { id: 2, time: "12:30", title: "機場出發", sub: "包車前往市區", link: "", ticket: false },
                        { id: 3, time: "13:30", title: "Nagoya PARCO", sub: "寶可夢/HARBS", link: "https://nagoya.parco.jp/", ticket: false },
                        { id: 4, time: "17:00", title: "前往民宿", sub: "Check-in (Ama)", link: "", ticket: false }
                    ]
                },
                { 
                    date: "1/8 (四)", shortDate: "1/8", title: "吉卜力公園", 
                    desc: "吉卜力公園全日遊，進入夢幻動畫世界。", location: "長久手", lat: 35.1709, lon: 137.0867, tags: ["吉卜力", "親子"],
                    tips: "🍃 吉卜力公園 (Ghibli Park)\n午餐：園區餐車\n🍽️ 晚餐：Steak House Asakuma (有自助吧，適合小孩)",
                    events: [
                        { id: 5, time: "09:00", title: "民宿出發", sub: "前往吉卜力", link: "", ticket: false },
                        { id: 6, time: "10:00", title: "吉卜力公園", sub: "Ghibli Park", link: "https://ghibli-park.jp/", ticket: false },
                        { id: 7, time: "18:00", title: "晚餐", sub: "Steak House Asakuma", link: "https://www.asakuma.co.jp/", ticket: false }
                    ]
                },
                { 
                    date: "1/9 (五)", shortDate: "1/9", title: "樂高樂園瘋玩日", 
                    desc: "LEGOLAND Japan 全日暢玩。", location: "金城ふ頭", lat: 35.0507, lon: 136.8436, tags: ["樂高", "遊樂園"],
                    tips: "🧱 日本樂高樂園(LEGOLAND Japan)\n午餐：樂園內解決",
                    events: [
                        { id: 8, time: "09:00", title: "民宿出發", sub: "前往樂高樂園", link: "", ticket: false },
                        { id: 9, time: "10:00", title: "LEGOLAND", sub: "全日暢玩", link: "https://www.legoland.jp/", ticket: false }
                    ]
                },
                { 
                    date: "1/10 (六)", shortDate: "1/10", title: "海洋世界 & 親子購物", 
                    desc: "名古屋港水族館看虎鯨，下午 LaLaport 購物。", location: "名古屋港", lat: 35.0906, lon: 136.8781, tags: ["水族館", "虎鯨", "阿卡將"],
                    tips: "🐬 名古屋港水族館 (看海豚秀、虎鯨)\n🛍️ LaLaport NAGOYA minato AQULS (阿卡將、Loft)\n晚餐：商場內美食街",
                    events: [
                        { id: 10, time: "09:30", title: "民宿出發", sub: "前往水族館", link: "", ticket: false },
                        { id: 11, time: "10:10", title: "名古屋港水族館", sub: "海豚秀/虎鯨", link: "https://nagoyaaqua.jp/", ticket: false },
                        { id: 12, time: "13:00", title: "午餐", sub: "漁港", link: "", ticket: false },
                        { id: 13, time: "14:30", title: "LaLaport", sub: "購物/晚餐", link: "https://mitsui-shopping-park.com/lalaport/minatoaquls/", ticket: false }
                    ]
                },
                { 
                    date: "1/11 (日)", shortDate: "1/11", title: "和服體驗 & 大須商店街", 
                    desc: "全家穿和服拍照，逛大須觀音與商店街。", location: "大須", lat: 35.1598, lon: 136.9019, tags: ["和服", "大須", "飛騨牛"],
                    tips: "👘 名古屋 Vasara 和服體驗 (名古屋車站店)\n🏮 大須商店街 & 三輪神社 (巨型招財貓)\n🍽️ 晚餐：燒肉 馬喰一代 飛驒牛",
                    events: [
                        { id: 14, time: "09:00", title: "民宿出發", sub: "前往 Vasara", link: "", ticket: false },
                        { id: 15, time: "10:00", title: "和服體驗", sub: "Vasara 名古屋站", link: "https://vasara-h.co.jp/", ticket: false },
                        { id: 16, time: "12:00", title: "大須商店街", sub: "三輪神社/逛街", link: "http://osu.co.jp/", ticket: false },
                        { id: 17, time: "16:00", title: "車站採買", sub: "周邊購物", link: "", ticket: false },
                        { id: 18, time: "18:00", title: "晚餐", sub: "馬喰一代 飛驒牛", link: "https://bakuroichidai.jp/", ticket: false }
                    ]
                },
                { 
                    date: "1/12 (一)", shortDate: "1/12", title: "快樂賦歸", 
                    desc: "前往機場，最後採買，準備搭機。", location: "中部機場", lat: 34.8588, lon: 136.8146, tags: ["蝦餅", "波音787"], 
                    tips: "🚐 08:30 準時 Check-out 發車\n✈️ 12:05 起飛 (建議 09:30 抵達)\n🛍️ 4樓藍天城：蝦餅之里\n✈️ FLIGHT OF DREAMS：看波音787",
                    events: [
                        { id: 19, time: "08:30", title: "民宿 Check-out", sub: "準時發車", link: "", ticket: false },
                        { id: 20, time: "09:30", title: "抵達機場", sub: "辦理登機", link: "https://www.centrair.jp/", ticket: false },
                        { id: 21, time: "10:30", title: "機場巡禮", sub: "蝦餅/波音787", link: "", ticket: false },
                        { id: 22, time: "12:05", title: "起飛", sub: "回溫暖的家", link: "", ticket: false }
                    ] 
                }
            ];
            
            const itinerary = ref([...defaultItinerary]); 
            const START_DATE_STR = '2026-01-07'; 

            const currentDayData = computed(() => itinerary.value[activeDayIndex.value]);
            const totalRealJPY = computed(() => expenses.value.filter(e => e.currency === 'JPY').reduce((sum, e) => sum + Number(e.amount), 0));
            const totalRealTWD = computed(() => expenses.value.filter(e => e.currency === 'TWD').reduce((sum, e) => sum + Number(e.amount), 0));
            const grandTotalInTWD = computed(() => Math.round(totalRealTWD.value + totalRealJPY.value * exchangeRate.value));
            const targetDate = new Date(START_DATE_STR);
            const daysRemaining = computed(() => { const today = new Date(); return Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24)); });
            const parsedTips = computed(() => marked.parse(currentDayData.value.tips || ''));

            // Firebase Logic
            let db;
            const collectionId = 'nagoya_2026'; 

            const initFirebase = () => {
                if (myFirebaseConfig.apiKey) {
                    try {
                        const app = initializeApp(myFirebaseConfig);
                        const auth = getAuth(app);
                        db = getFirestore(app);

                        signInAnonymously(auth);
                        onAuthStateChanged(auth, (user) => {
                            if (user) {
                                dbConnected.value = true;
                                onSnapshot(collection(db, 'expenses_nagoya'), (snap) => {
                                    expenses.value = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => b.createdAt - a.createdAt);
                                });
                                onSnapshot(doc(db, 'plans', collectionId), (docSnap) => {
                                    if (docSnap.exists()) {
                                        const data = docSnap.data();
                                        if (data.days) itinerary.value = data.days;
                                        if (data.officeInfo) officeInfo.value = data.officeInfo;
                                        if (data.emergencyContact) emergencyContact.value = data.emergencyContact;
                                        if (data.members) members.value = data.members; // Load members
                                    } else {
                                        setDoc(doc(db, 'plans', collectionId), { days: defaultItinerary, officeInfo: officeInfo.value, emergencyContact: emergencyContact.value, members: members.value });
                                    }
                                });
                            }
                        });
                    } catch (e) { console.error("Firebase Init Failed", e); alert("Firebase 連線失敗"); }
                }
            };
            
            const saveItinerary = () => {
                if (dbConnected.value) {
                    setDoc(doc(db, 'plans', collectionId), { 
                        days: itinerary.value,
                        officeInfo: officeInfo.value,
                        emergencyContact: emergencyContact.value,
                        members: members.value // Save members
                    }, { merge: true });
                }
            };

            // Add/Remove Member Logic
            const addMember = () => {
                if (newMemberName.value.trim()) {
                    members.value.push(newMemberName.value.trim());
                    newMemberName.value = '';
                    saveItinerary();
                }
            };

            const removeMember = (index) => {
                if (confirm(`確定移除成員 ${members.value[index]} 嗎？`)) {
                    members.value.splice(index, 1);
                    saveItinerary();
                }
            };

            const switchDay = (i) => { 
                currentView.value = 'itinerary'; 
                activeDayIndex.value = i; 
                isEditingTip.value = false; 
                isEditingTitle.value = false;
                isEditingDate.value = false; // reset
                isEditingLocation.value = false; // reset
            };
            const getDayIcon = (i) => i === 0 || i === itinerary.value.length - 1 ? 'plane' : (i % 3 === 0 ? 'gamepad-2' : 'map-pin'); 
            const getWeatherIcon = (w) => w === 'snow' ? 'snowflake' : (w === 'sun' ? 'sun' : 'cloud');
            
            // --- 標題編輯 ---
            const startEditTitle = () => { tempTitle.value = {title: currentDayData.value.title, desc: currentDayData.value.desc}; isEditingTitle.value = true; };
            const saveTitle = () => { 
                itinerary.value[activeDayIndex.value].title = tempTitle.value.title; 
                itinerary.value[activeDayIndex.value].desc = tempTitle.value.desc;
                isEditingTitle.value = false;
                saveItinerary();
            };

            // --- 日期編輯與自動連動 (修改後) ---
            const startEditDate = () => {
                tempDateString.value = currentDayData.value.date;
                isEditingDate.value = true;
            };
            
            const saveDate = () => {
                const input = tempDateString.value;
                // 嘗試解析日期，支援 "1/9", "01/09", "1-9" 等格式
                const match = input.match(/(\d{1,2})[/-月](\d{1,2})/);
                
                if (match) {
                    const month = parseInt(match[1]);
                    const date = parseInt(match[2]);
                    const year = 2026; // 固定年份
                    const newDateObj = new Date(year, month - 1, date);
                    
                    // 從目前這一天開始，往後更新每一天
                    for (let i = activeDayIndex.value; i < itinerary.value.length; i++) {
                        const current = new Date(newDateObj);
                        // 計算與目前這一天的天數差距，然後加回去
                        current.setDate(newDateObj.getDate() + (i - activeDayIndex.value));
                        
                        const dayOfWeek = ['日', '一', '二', '三', '四', '五', '六'][current.getDay()];
                        itinerary.value[i].date = `${current.getMonth() + 1}/${current.getDate()} (${dayOfWeek})`;
                        itinerary.value[i].shortDate = `${current.getMonth() + 1}/${current.getDate()}`;
                    }
                } else {
                    // 解析失敗，僅更新當前文字 (不連動)
                    itinerary.value[activeDayIndex.value].date = input;
                }
                
                isEditingDate.value = false;
                saveItinerary();
            };

            // --- 地點/天氣編輯 ---
            const startEditLocation = () => {
                tempLocation.value = {
                    name: currentDayData.value.location,
                    lat: currentDayData.value.lat,
                    lon: currentDayData.value.lon
                };
                isEditingLocation.value = true;
            };
            const saveLocation = () => {
                itinerary.value[activeDayIndex.value].location = tempLocation.value.name;
                itinerary.value[activeDayIndex.value].lat = parseFloat(tempLocation.value.lat);
                itinerary.value[activeDayIndex.value].lon = parseFloat(tempLocation.value.lon);
                isEditingLocation.value = false;
                saveItinerary();
                fetchRealTimeWeather(); // 立即更新天氣
            };

            // --- 求助資訊儲存 ---
            const saveOfficeInfo = () => { isEditingOffice.value = false; saveItinerary(); };
            const saveEmergencyContact = () => { isEditingContact.value = false; saveItinerary(); };

            // --- 行程排序邏輯 (視覺化版) ---
            const moveDay = (index, direction) => {
                if (direction === -1 && index > 0) {
                    // Move Up: Swap with previous
                    [itinerary.value[index], itinerary.value[index-1]] = [itinerary.value[index-1], itinerary.value[index]];
                    
                    // 若當前顯示的是移動的那天，跟著移動索引
                    if (activeDayIndex.value === index) activeDayIndex.value = index - 1;
                    else if (activeDayIndex.value === index - 1) activeDayIndex.value = index;

                } else if (direction === 1 && index < itinerary.value.length - 1) {
                    // Move Down: Swap with next
                    [itinerary.value[index], itinerary.value[index+1]] = [itinerary.value[index+1], itinerary.value[index]];
                    
                    // 若當前顯示的是移動的那天，跟著移動索引
                    if (activeDayIndex.value === index) activeDayIndex.value = index + 1;
                    else if (activeDayIndex.value === index + 1) activeDayIndex.value = index;
                }
                
                // 排序後必須重算日期，保持日期連續性
                recalculateDates();
                saveItinerary();
            };

            // --- 行程編輯與排序 ---
            const startEditEvent = (e) => { editingEventId.value = e.id; tempEvent.value = {...e}; tempTicketFile.value = null; };
            const cancelEditEvent = () => { editingEventId.value = null; tempEvent.value = {}; tempTicketFile.value = null; };
            
            const compressImage = (file) => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            const maxWidth = 1024; 
                            let width = img.width;
                            let height = img.height;
                            if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                            canvas.width = width; canvas.height = height;
                            ctx.drawImage(img, 0, 0, width, height);
                            resolve(canvas.toDataURL('image/jpeg', 0.6)); 
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            };

            const handleTicketUpload = async (event) => {
                const file = event.target.files[0];
                if (file) {
                    isUploading.value = true;
                    try {
                        tempTicketFile.value = await compressImage(file);
                    } catch(e) { console.error(e); }
                    isUploading.value = false;
                }
            };

            const saveEditEvent = async (idx) => { 
                isUploading.value = true;
                const eventId = String(tempEvent.value.id);
                if (tempTicketFile.value && dbConnected.value) {
                    try {
                        await setDoc(doc(db, 'tickets_nagoya', eventId), { image: tempTicketFile.value });
                        tempEvent.value.ticket = true; 
                    } catch(e) {
                        alert("上傳失敗，請確認網路連線");
                    }
                }
                
                // 儲存資料
                itinerary.value[activeDayIndex.value].events[idx] = {...tempEvent.value};
                
                // 自動排序 (時間格式為 HH:MM)
                itinerary.value[activeDayIndex.value].events.sort((a, b) => a.time.localeCompare(b.time));

                editingEventId.value = null; 
                saveItinerary();
                isUploading.value = false;
            };

            const deleteTicketInEdit = async (idx) => {
                if(confirm('確定刪除此憑證圖片嗎？')) {
                    if (dbConnected.value) {
                        try { await deleteDoc(doc(db, 'tickets_nagoya', String(tempEvent.value.id))); } catch(e) {}
                    }
                    tempEvent.value.ticket = false;
                    tempTicketFile.value = null;
                }
            };

            const openTicketViewer = async (event) => {
                viewingTicket.value = true;
                ticketImageUrl.value = null;
                if (dbConnected.value) {
                    const snap = await getDoc(doc(db, 'tickets_nagoya', String(event.id)));
                    if (snap.exists()) {
                        ticketImageUrl.value = snap.data().image;
                    } else {
                        alert("找不到憑證圖片");
                        viewingTicket.value = false;
                    }
                } else {
                    alert("請連接網路以查看憑證");
                    viewingTicket.value = false;
                }
            };

            const closeTicketViewer = () => { viewingTicket.value = false; ticketImageUrl.value = null; };

            // Modified addNewEvent: Auto-enters edit mode
            const addNewEvent = () => {
                const newId = Date.now();
                const newEvent = { 
                    id: newId, 
                    time: "12:00", 
                    title: "新行程", 
                    sub: "地點/描述", 
                    link: "", 
                    ticket: false 
                };
                
                // Add to list
                itinerary.value[activeDayIndex.value].events.push(newEvent);
                
                // Sort (though with default 12:00 it might land in middle, let's just sort)
                itinerary.value[activeDayIndex.value].events.sort((a, b) => a.time.localeCompare(b.time));
                
                // Find index after sort
                const idx = itinerary.value[activeDayIndex.value].events.findIndex(e => e.id === newId);
                
                // Set editing state
                editingEventId.value = newId;
                tempEvent.value = { ...newEvent };
                tempTicketFile.value = null;
                
                saveItinerary();
            };

            const deleteEvent = async (idx) => { 
                if(confirm("確定刪除此行程與憑證？")) {
                    const event = itinerary.value[activeDayIndex.value].events[idx];
                    if (event.ticket && dbConnected.value) {
                        await deleteDoc(doc(db, 'tickets_nagoya', String(event.id)));
                    }
                    itinerary.value[activeDayIndex.value].events.splice(idx, 1);
                    saveItinerary();
                }
            };
            
            const startEditTip = () => { tempTip.value = currentDayData.value.tips; isEditingTip.value = true; };
            const saveTip = () => { 
                itinerary.value[activeDayIndex.value].tips = tempTip.value; 
                isEditingTip.value = false; 
                saveItinerary();
            };

            const addExpense = async () => {
                if (!newExpense.value.title) return;
                const data = { ...newExpense.value, amount: Number(newExpense.value.amount), date: new Date().toLocaleDateString('zh-TW'), createdAt: Date.now() };
                if (dbConnected.value) await addDoc(collection(db, 'expenses_nagoya'), data);
                else expenses.value.unshift({ id: Date.now(), ...data });
                newExpense.value.title = ''; newExpense.value.amount = '';
            };
            const deleteExpense = async (id) => { if(confirm("確定刪除？")) dbConnected.value ? await deleteDoc(doc(db, 'expenses_nagoya', id)) : expenses.value = expenses.value.filter(e => e.id !== id); };
            const startEditExpense = (ex) => { editingExpenseId.value = ex.id; tempExpense.value = JSON.parse(JSON.stringify(ex)); };
            const saveEditExpense = async () => {
                const { id, ...data } = tempExpense.value;
                if (dbConnected.value) await updateDoc(doc(db, 'expenses_nagoya', id), data);
                else { const idx = expenses.value.findIndex(e => e.id === id); if(idx !== -1) expenses.value[idx] = { id, ...data }; }
                editingExpenseId.value = null;
            };
            const cancelEditExpense = () => editingExpenseId.value = null;
            const toggleSplitter = (obj, m) => { const idx = obj.splitters.indexOf(m); idx > -1 ? obj.splitters.splice(idx, 1) : obj.splitters.push(m); };
            const toggleAllSplitters = (obj) => { obj.splitters = obj.splitters.length === members.value.length ? [] : [...members.value]; };

            const calculateSettlement = () => {
                let debtsJPY = {}, debtsTWD = {}; members.value.forEach(m => { debtsJPY[m] = 0; debtsTWD[m] = 0; });
                expenses.value.forEach(ex => {
                    if (ex.payer === '公費') return;
                    if (ex.splitters && ex.splitters.length > 0) {
                        let amount = Math.round(ex.amount / ex.splitters.length);
                        if (ex.currency === 'JPY') { debtsJPY[ex.payer] += ex.amount; ex.splitters.forEach(s => debtsJPY[s] -= amount); } 
                        else { debtsTWD[ex.payer] += ex.amount; ex.splitters.forEach(s => debtsTWD[s] -= amount); }
                    }
                });
                settlementStats.value = members.value.map(m => ({ name: m, netJPY: debtsJPY[m], netTWD: debtsTWD[m] }));
                const getTransfers = (debts) => {
                    let debtors = [], creditors = [], results = [];
                    for (const [name, amount] of Object.entries(debts)) { if (amount < -1) debtors.push({ name, amount }); if (amount > 1) creditors.push({ name, amount }); }
                    debtors.sort((a, b) => a.amount - b.amount); creditors.sort((a, b) => b.amount - a.amount);
                    let i = 0, j = 0;
                    while (i < debtors.length && j < creditors.length) {
                        let amount = Math.min(Math.abs(debtors[i].amount), creditors[j].amount);
                        if (amount > 0) results.push({ from: debtors[i].name, to: creditors[j].name, amount });
                        debtors[i].amount += amount; creditors[j].amount -= amount;
                        if (Math.abs(debtors[i].amount) < 1) i++; if (creditors[j].amount < 1) j++;
                    }
                    return results;
                };
                transfersJPY.value = getTransfers(debtsJPY); transfersTWD.value = getTransfers(debtsTWD);
                showSettlementModal.value = true;
            };
            
            const recalculateDates = () => {
                const start = new Date(START_DATE_STR);
                itinerary.value.forEach((day, index) => {
                    const current = new Date(start);
                    current.setDate(start.getDate() + index);
                    const dayOfWeek = ['日', '一', '二', '三', '四', '五', '六'][current.getDay()];
                    day.date = `${current.getMonth() + 1}/${current.getDate()} (${dayOfWeek})`;
                    day.shortDate = `${current.getMonth() + 1}/${current.getDate()}`;
                });
            };

            const insertDay = (targetIndex = -1) => {
                // If targetIndex is provided (e.g. from bottom of list), append there. 
                // If -1 (from default call), use activeDayIndex.
                const indexToInsertAfter = targetIndex >= 0 ? targetIndex : activeDayIndex.value;
                
                const newDay = {
                    title: "新行程 (插入)", 
                    desc: "請編輯行程內容", 
                    location: "待定", 
                    lat: 35.1815, lon: 136.9066, // Default Nagoya
                    tags: [], 
                    tips: "點擊編輯填寫", 
                    events: []
                };
                
                itinerary.value.splice(indexToInsertAfter + 1, 0, newDay);
                recalculateDates();
                saveItinerary();
                
                // Only switch day if not in reorder view (to avoid jumping context unexpectedly)
                if (currentView.value !== 'reorder') {
                    switchDay(indexToInsertAfter + 1);
                }
            };

            // Modified to accept index for reorder page
            const removeDay = (index) => {
                const targetIdx = index !== undefined ? index : activeDayIndex.value;
                
                if (itinerary.value.length > 1) {
                    if (confirm(`確定刪除 Day ${targetIdx + 1} 及其所有內容嗎？\n刪除後，後面的日期將會自動遞補。`)) {
                        itinerary.value.splice(targetIdx, 1);
                        
                        // Adjust active index if we deleted the current or a previous one
                        if (activeDayIndex.value >= itinerary.value.length) {
                            activeDayIndex.value = itinerary.value.length - 1;
                        } else if (targetIdx < activeDayIndex.value) {
                            activeDayIndex.value--;
                        }
                        
                        recalculateDates();
                        saveItinerary();
                    }
                } else {
                    alert("至少需保留一天行程");
                }
            };
            
            // Kept for backward compatibility with sidebar button if any
            const removeCurrentDay = () => removeDay(activeDayIndex.value);
            
            const fetchExchangeRate = async () => { isRateLoading.value = true; try { const res = await fetch('https://api.exchangerate-api.com/v4/latest/JPY'); const data = await res.json(); if(data.rates) exchangeRate.value = data.rates.TWD; } catch {} finally { isRateLoading.value = false; } };
            
            const fetchRealTimeWeather = async () => {
                const day = currentDayData.value;
                if (!day.lat) { weatherState.value = { status: 'too_early', data: null }; return; }
                const tripStartDate = new Date(START_DATE_STR); 
                const targetDayDate = new Date(tripStartDate); targetDayDate.setDate(tripStartDate.getDate() + activeDayIndex.value);
                if (Math.ceil((targetDayDate - new Date()) / 86400000) > 14) { weatherState.value = { status: 'too_early', data: null }; return; }
                weatherState.value = { status: 'loading', data: null };
                const dateStr = targetDayDate.toISOString().split('T')[0];
                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${day.lat}&longitude=${day.lon}&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Asia%2FTokyo&start_date=${dateStr}&end_date=${dateStr}`);
                    const data = await res.json();
                    if (data.daily) weatherState.value = { status: 'available', data: { max: Math.round(data.daily.temperature_2m_max[0]), min: Math.round(data.daily.temperature_2m_min[0]), code: data.daily.weathercode[0] } };
                } catch { weatherState.value = { status: 'too_early', data: null }; }
            };
            watch(activeDayIndex, fetchRealTimeWeather, { immediate: true });

            onMounted(() => { 
                lucide.createIcons(); 
                fetchExchangeRate();
                if (myFirebaseConfig.apiKey) initFirebase();
            });
            
            watch([currentView, activeDayIndex, expenses.value, isEditingTip, editingEventId, viewingTicket, tempTicketFile, isEditingDate, isEditingLocation, isEditingOffice, isEditingContact], () => nextTick(() => lucide.createIcons()));

            return {
                currentView, activeDayIndex, itinerary, currentDayData, switchDay, getDayIcon, getWeatherIcon,
                expenses, newExpense, addExpense, deleteExpense, startEditExpense, saveEditExpense, cancelEditExpense, editingExpenseId, tempExpense,
                totalRealJPY, totalRealTWD, grandTotalInTWD, exchangeRate, members, daysRemaining,
                isEditingTip, tempTip, startEditTip, saveTip, parsedTips,
                toggleSplitter, toggleAllSplitters, showSettlement: calculateSettlement, showSettlementModal, settlementStats, transfersJPY, transfersTWD,
                weatherState, dbConnected, 
                insertDay, removeCurrentDay, removeDay,
                fetchExchangeRate, isRateLoading,
                editingEventId, tempEvent, startEditEvent, saveEditEvent, cancelEditEvent, addNewEvent, deleteEvent,
                isEditingTitle, tempTitle, startEditTitle, saveTitle,
                // Ticket related
                handleTicketUpload, isUploading, tempTicketFile, deleteTicketInEdit, openTicketViewer, closeTicketViewer, viewingTicket, ticketImageUrl,
                // New features
                isEditingDate, tempDateString, startEditDate, saveDate,
                isEditingLocation, tempLocation, startEditLocation, saveLocation,
                timeOptions,
                // Emergency
                isEditingOffice, officeInfo, saveOfficeInfo,
                isEditingContact, emergencyContact, saveEmergencyContact,
                // Reorder
                moveDay,
                // Settings Members
                addMember, removeMember, newMemberName
            };
        }
    }).mount('#app');
</script>
</body>
</html>
